<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <meta name="description" content="MoveisBonafe - Painel administrativo completo.">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-badge {
            background: #4a90e2;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .admin-label {
            background: #ff4757;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: #ff3742;
        }
        
        .nav-tabs {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            padding: 0 20px;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #666;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            color: #4a90e2;
            background: #f8f9fa;
        }
        
        .nav-tab.active {
            color: #4a90e2;
            border-bottom-color: #4a90e2;
            background: #f8f9fa;
        }
        
        .tab-icon {
            font-size: 16px;
        }
        
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tab-content {
            display: none;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #4a90e2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #357abd;
        }
        
        .btn-success {
            background: #5cb85c;
            color: white;
        }
        
        .btn-success:hover {
            background: #449d44;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .product-image-cell {
            width: 60px;
            height: 60px;
            background: #f5f5f5;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
            overflow: hidden;
        }
        
        .product-image-cell img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .action-buttons-cell {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-edit {
            background: #f39c12;
            color: white;
        }
        
        .btn-edit:hover {
            background: #e67e22;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .price-cell {
            font-weight: 600;
            color: #27ae60;
        }
        
        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #666;
        }
        
        .loading {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #666;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #545b62;
        }
        
        .category-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .category-image-placeholder {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #999;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .nav-tabs {
                padding: 0 10px;
            }
            
            .nav-tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .content {
                padding: 12px;
            }
            
            .content-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span class="admin-badge">📋 Admin Panel</span>
            <span class="admin-label">Administrador</span>
        </div>
        <div class="header-right">
            <button id="github-token-btn" class="btn" onclick="configureGitHubToken()" style="margin-right: 15px; padding: 8px 16px; font-size: 14px; font-weight: bold; background: #ffc107; color: #212529; border: 2px solid #fff; border-radius: 6px;">
                🔑 Configurar GitHub Token
            </button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('produtos')" data-tab="produtos">
            <span class="tab-icon">📦</span>
            <span>Produtos</span>
        </div>
        <div class="nav-tab" onclick="showTab('categorias')" data-tab="categorias">
            <span class="tab-icon">🏷️</span>
            <span>Categorias</span>
        </div>
        <div class="nav-tab" onclick="showTab('cores')" data-tab="cores">
            <span class="tab-icon">🎨</span>
            <span>Cores</span>
        </div>
        <div class="nav-tab" onclick="showTab('precos')" data-tab="precos">
            <span class="tab-icon">💰</span>
            <span>Preços</span>
        </div>
        <div class="nav-tab" onclick="showTab('usuarios')" data-tab="usuarios">
            <span class="tab-icon">👥</span>
            <span>Usuários</span>
        </div>
        <div class="nav-tab" onclick="showTab('promocoes')" data-tab="promocoes">
            <span class="tab-icon">🎯</span>
            <span>Promoções</span>
        </div>
        <div class="nav-tab" onclick="showTab('excel')" data-tab="excel">
            <span class="tab-icon">📊</span>
            <span>Excel</span>
        </div>
        <div class="nav-tab" onclick="showTab('backup')" data-tab="backup">
            <span class="tab-icon">💾</span>
            <span>Backup</span>
        </div>
        <div class="nav-tab" onclick="showTab('monitor')" data-tab="monitor">
            <span class="tab-icon">📈</span>
            <span>Monitor</span>
        </div>
    </div>

    <div class="content">
        <!-- Produtos Tab -->
        <div id="produtos-tab" class="tab-content active">
            <div class="content-header">
                <h2 class="content-title">Gerenciar Produtos</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openProductModal()">
                        ➕ Novo Produto
                    </button>
                </div>
            </div>
            <div id="produtos-loading" class="loading">Carregando produtos...</div>
            <div id="produtos-content" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Imagem</th>
                            <th>Produto</th>
                            <th>À Vista</th>
                            <th>30</th>
                            <th>30/60</th>
                            <th>30/60/90</th>
                            <th>30/60/90/120</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="produtos-table">
                    </tbody>
                </table>
                <div id="produtos-empty" class="empty-state" style="display: none;">
                    <h3>Nenhum produto cadastrado</h3>
                    <p>Comece adicionando seu primeiro produto</p>
                </div>
            </div>
        </div>

        <!-- Categorias Tab -->
        <div id="categorias-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Gerenciar Categorias</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        ➕ Nova Categoria
                    </button>
                </div>
            </div>
            <div id="categorias-loading" class="loading">Carregando categorias...</div>
            <div id="categorias-content" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Cor</th>
                            <th>Produtos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-table">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Preços Tab -->
        <div id="precos-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Gerenciar Tabelas de Preços</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openPriceModal()">
                        ➕ Nova Tabela
                    </button>
                </div>
            </div>
            <div id="precos-loading" class="loading">Carregando tabelas de preços...</div>
            <div id="precos-content" style="display: none;">
                <h3 style="margin-bottom: 16px; color: #333; font-size: 16px;">Tabelas de Preços Configuradas</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome da Tabela</th>
                            <th>Percentual (%)</th>
                            <th>Multiplicador</th>
                            <th>Exemplo (R$ 100)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="precos-table">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cores Tab -->
        <div id="cores-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Gerenciar Cores</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openColorModal()">
                        ➕ Nova Cor
                    </button>
                </div>
            </div>
            <div id="cores-loading" class="loading">Carregando cores...</div>
            <div id="cores-content" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cor</th>
                            <th>Código Hex</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="cores-table">
                    </tbody>
                </table>
                <div id="cores-empty" class="empty-state" style="display: none;">
                    <h3>Nenhuma cor cadastrada</h3>
                    <p>Comece adicionando sua primeira cor</p>
                </div>
            </div>
        </div>

        <div id="usuarios-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Gerenciar Usuários</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openUserModal()">
                        ➕ Novo Usuário
                    </button>
                </div>
            </div>
            <div id="usuarios-loading" class="loading">Carregando usuários...</div>
            <div id="usuarios-content" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Username</th>
                            <th>Função</th>
                            <th>Multiplicador</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usuarios-table">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Promoções Tab -->
        <div id="promocoes-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">🎯 Gerenciar Promoções</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openPromotionModal()">
                        ➕ Nova Promoção
                    </button>
                </div>
            </div>
            <div id="promocoes-loading" class="loading">Carregando promoções...</div>
            <div id="promocoes-content" style="display: none;">
                <div class="promotion-info" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 16px;">💡</span>
                        <strong style="color: #1976d2;">Dica:</strong>
                    </div>
                    <p style="color: #1976d2; font-size: 14px; margin: 0;">
                        Apenas uma promoção pode estar ativa por vez. Ao ativar uma nova promoção, as outras serão automaticamente desativadas.
                    </p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Texto</th>
                            <th>Descrição</th>
                            <th>Cor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="promocoes-table">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Excel Tab -->
        <div id="excel-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Importar/Exportar Excel</h2>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px;">
                    <!-- Import Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="font-size: 20px;">📥</span>
                            <h3 style="margin: 0; color: #333;">Importar Produtos</h3>
                        </div>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Importe produtos em massa usando arquivo Excel (.xlsx) ou CSV
                        </p>
                        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleExcelUpload(event)">
                        <button class="btn btn-success" onclick="document.getElementById('excel-upload').click()">
                            📊 Selecionar Excel/CSV
                        </button>
                    </div>
                    
                    <!-- Export Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="font-size: 20px;">📤</span>
                            <h3 style="margin: 0; color: #333;">Exportar Produtos</h3>
                        </div>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Exporte todos os produtos para arquivo Excel (.xlsx)
                        </p>
                        <button class="btn btn-primary" onclick="exportToCSV()">
                            📊 Baixar Excel
                        </button>
                    </div>
                </div>
                
                <!-- Format Guide -->
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                    <h3 style="margin: 0 0 16px 0; color: #333;">Formato de Importação</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Preço</th>
                                <th>Altura</th>
                                <th>Largura</th>
                                <th>Comprimento</th>
                                <th>Peso</th>
                                <th>Descrição</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sofá 3 Lugares</td>
                                <td>Sala de Estar</td>
                                <td>1200.00</td>
                                <td>85</td>
                                <td>200</td>
                                <td>90</td>
                                <td>45.5</td>
                                <td>Sofá confortável para sala</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="color: #666; font-size: 13px; margin: 12px 0 0 0;">
                        <strong>Importante:</strong> Cada informação deve estar em uma coluna separada. O sistema aceita arquivos Excel (.xlsx) ou CSV com separação por vírgula ou TAB.
                    </p>
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">💾 Backup do Sistema</h2>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                    <!-- Backup Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #333;">Fazer Backup</h3>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Baixe todos os dados do sistema em formato JSON
                        </p>
                        <button class="btn btn-primary" onclick="downloadBackup()">
                            📥 Baixar Backup Completo
                        </button>
                    </div>
                    
                    <!-- Restore Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #333;">Restaurar Backup</h3>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Restaure dados de um arquivo de backup JSON
                        </p>
                        <input type="file" id="backup-upload" accept=".json" style="display: none;" onchange="handleBackupRestore(event)">
                        <button class="btn btn-success" onclick="document.getElementById('backup-upload').click()">
                            📤 Selecionar Backup
                        </button>
                    </div>
                </div>
                
                <!-- Backup Info -->
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 24px;">
                    <h3 style="margin: 0 0 16px 0; color: #333;">Informações do Sistema</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <strong>Última Atualização:</strong><br>
                            <span id="last-backup-date">-</span>
                        </div>
                        <div>
                            <strong>Total de Registros:</strong><br>
                            <span id="total-records">-</span>
                        </div>
                        <div>
                            <strong>Tamanho dos Dados:</strong><br>
                            <span id="data-size">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div id="monitor-tab" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">📈 Monitor do Sistema</h2>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; color: #4a90e2; font-size: 2rem;" id="monitor-products">-</h3>
                        <p style="margin: 0; color: #666;">Produtos Ativos</p>
                    </div>
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; color: #5cb85c; font-size: 2rem;" id="monitor-categories">-</h3>
                        <p style="margin: 0; color: #666;">Categorias</p>
                    </div>
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; color: #f39c12; font-size: 2rem;" id="monitor-users">-</h3>
                        <p style="margin: 0; color: #666;">Usuários Ativos</p>
                    </div>
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; color: #e74c3c; font-size: 2rem;" id="monitor-promotions">-</h3>
                        <p style="margin: 0; color: #666;">Promoções Ativas</p>
                    </div>
                </div>
                
                <!-- GitHub Configuration -->
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span id="github-status-online" style="display: inline-block; width: 12px; height: 12px; background: #5cb85c; border-radius: 50%;"></span>
                        <span style="color: #5cb85c; font-weight: bold;">Online</span>
                        <span id="github-status-token" style="display: inline-block; width: 12px; height: 12px; background: #5cb85c; border-radius: 50%; margin-left: 20px;"></span>
                        <span id="github-status-token-text" style="color: #5cb85c; font-weight: bold;">Token válido</span>
                    </div>
                    
                    <h3 style="margin: 0 0 16px 0; color: #333;">⚙️ Configuração GitHub</h3>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Token GitHub (para upload de imagens):</label>
                        <input type="password" id="github-token-input" placeholder="•••••••••••••••••••••••••••••••••••••••••" 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                    </div>
                    
                    <button onclick="saveGitHubToken()" style="background: #f39c12; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Salvar Token
                    </button>
                    
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 16px; margin-top: 16px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">Como funciona a sincronização:</h4>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #666;">
                            <li>Configure o token UMA ÚNICA VEZ neste dispositivo</li>
                            <li>Todos os dispositivos verão automaticamente os produtos</li>
                            <li>Clientes NÃO precisam configurar nada</li>
                            <li>Imagens ficam disponíveis para todos automaticamente</li>
                        </ul>
                        
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">
                            <strong>Token necessário para fazer upload de imagens para o repositório GitHub</strong><br>
                            <span style="color: #e74c3c;">Token carregado do armazenamento local</span>
                        </p>
                    </div>
                </div>

                <!-- System Status -->
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                    <h3 style="margin: 0 0 16px 0; color: #333;">Status do Sistema</h3>
                    <table class="data-table">
                        <tbody>
                            <tr>
                                <td><strong>Plataforma</strong></td>
                                <td>GitHub Pages</td>
                            </tr>
                            <tr>
                                <td><strong>Modo de Operação</strong></td>
                                <td>Somente Leitura (JSON Estático)</td>
                            </tr>
                            <tr>
                                <td><strong>Autenticação</strong></td>
                                <td>Local (SessionStorage)</td>
                            </tr>
                            <tr>
                                <td><strong>Armazenamento</strong></td>
                                <td>Arquivos JSON no GitHub</td>
                            </tr>
                            <tr>
                                <td><strong>Performance</strong></td>
                                <td><span style="color: #5cb85c;">✓ Ótima (CDN Global)</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Produto</h3>
                <button class="close-btn" onclick="closeModal('product-modal')">&times;</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" class="form-input" id="product-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="product-category" required>
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Preço (R$)</label>
                    <input type="number" class="form-input" id="product-price" step="0.01" required>
                </div>
                
                <!-- Dimensões - seguindo modelo Excel -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Altura (cm)</label>
                        <input type="number" class="form-input" id="product-altura" step="0.01" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Largura (cm)</label>
                        <input type="number" class="form-input" id="product-largura" step="0.01" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comprimento (cm)</label>
                        <input type="number" class="form-input" id="product-comprimento" step="0.01" placeholder="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <input type="number" class="form-input" id="product-peso" step="0.01" placeholder="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea class="form-input" id="product-description" rows="3" placeholder="Descrição detalhada do produto"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagens do Produto</label>
                    <input type="file" class="form-input" id="product-images" accept="image/*" multiple onchange="handleMultipleImageUpload(event)">
                    <small style="color: #666;">Formatos aceitos: JPG, PNG, WebP (máx. 2MB cada). Selecione múltiplas imagens.</small>
                    <div id="image-preview-container" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Preview das imagens será mostrado aqui -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Variações de Cores</label>
                    <div id="color-variations" style="border: 1px solid #ddd; border-radius: 6px; padding: 16px; background: #f9f9f9;">
                        <div style="margin-bottom: 12px;">
                            <button type="button" class="btn btn-primary btn-sm" onclick="addColorVariation()">+ Adicionar Cor</button>
                        </div>
                        <div id="color-list" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Color variations will be added here -->
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('product-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Categoria</h3>
                <button class="close-btn" onclick="closeModal('category-modal')">&times;</button>
            </div>
            <form id="category-form">
                <div class="form-group">
                    <label class="form-label">Nome da Categoria</label>
                    <input type="text" class="form-input" id="category-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <input type="text" class="form-input" id="category-description">
                </div>
                <div class="form-group">
                    <label class="form-label">Cor</label>
                    <input type="color" class="form-input" id="category-color" value="#4a90e2">
                </div>
                <div class="form-group">
                    <label class="form-label">Imagem da Categoria</label>
                    <input type="file" class="form-input" id="category-image" accept="image/*" onchange="handleImageUpload(event, 'category')">
                    <small style="color: #666;">Formatos aceitos: JPG, PNG, WebP (máx. 2MB)</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('category-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Color Modal -->
    <div id="color-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Cor</h3>
                <button class="close-btn" onclick="closeModal('color-modal')">&times;</button>
            </div>
            <form id="color-form">
                <div class="form-group">
                    <label class="form-label">Nome da Cor</label>
                    <input type="text" class="form-input" id="color-name" required placeholder="ex: Branco, Preto, Marrom">
                </div>
                <div class="form-group">
                    <label class="form-label">Código da Cor</label>
                    <input type="color" class="form-input" id="color-code" value="#ffffff" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('color-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Usuário</h3>
                <button class="close-btn" onclick="closeModal('user-modal')">&times;</button>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="user-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="user-username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="user-password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Função</label>
                    <select class="form-select" id="user-role" required>
                        <option value="">Selecione uma função</option>
                        <option value="admin">Administrador</option>
                        <option value="loja">Loja</option>
                        <option value="restaurante">Restaurante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Multiplicador de Preço</label>
                    <input type="number" class="form-input" id="user-multiplier" step="0.01" value="1.00" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('user-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // GitHub Pages Admin Client
        class AdminClient {
            constructor() {
                this.baseUrl = window.location.origin + window.location.pathname.replace('/admin.html', '');
                this.data = {
                    products: [],
                    categories: [],
                    colors: [],
                    users: [],
                    priceSettings: [],
                    promotions: []
                };
            }

            async loadData(filename) {
                try {
                    // Try to load from GitHub first
                    const response = await fetch(`${this.baseUrl}/data/${filename}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.log(`GitHub data unavailable for ${filename}, checking localStorage...`);
                    
                    // Fallback to localStorage
                    const dataType = filename.replace('.json', '').replace('_', '');
                    const localKey = `moveisbonafe_${dataType === 'pricesettings' ? 'priceSettings' : dataType}`;
                    const localData = localStorage.getItem(localKey);
                    
                    if (localData) {
                        console.log(`Loaded ${filename} from localStorage`);
                        return JSON.parse(localData);
                    }
                    
                    console.error(`No data found for ${filename} in GitHub or localStorage`);
                    return [];
                }
            }

            async init() {
                // Check authentication
                const userSession = sessionStorage.getItem('currentUser');
                if (!userSession) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = JSON.parse(userSession);
                if (user.role !== 'admin') {
                    alert('Acesso negado. Apenas administradores podem acessar esta área.');
                    window.location.href = 'login.html';
                    return;
                }

                await this.loadAllData();
                this.renderProducts();
                this.renderCategories();
                this.renderColors();
                this.renderUsers();
                this.renderPriceSettings();
                this.renderPromotions();
                this.updateMonitorData();
            }

            async loadAllData() {
                try {
                    // First, load from localStorage (most recent changes)
                    const localProducts = localStorage.getItem('moveisbonafe_products');
                    const localCategories = localStorage.getItem('moveisbonafe_categories');
                    const localUsers = localStorage.getItem('moveisbonafe_users');
                    const localPriceSettings = localStorage.getItem('moveisbonafe_price_settings');
                    const localPromotions = localStorage.getItem('moveisbonafe_promotions');

                    // If localStorage has data, use it (preserves deletions and edits)
                    if (localProducts) {
                        this.data.products = JSON.parse(localProducts);
                        console.log(`📦 Carregado ${this.data.products.length} produtos do localStorage`);
                    } else {
                        const products = await this.loadData('products.json');
                        this.data.products = products || [];
                    }

                    if (localCategories) {
                        this.data.categories = JSON.parse(localCategories);
                    } else {
                        const categories = await this.loadData('categories.json');
                        this.data.categories = categories || [];
                    }

                    if (localUsers) {
                        this.data.users = JSON.parse(localUsers);
                    } else {
                        const users = await this.loadData('users.json');
                        this.data.users = users || [];
                    }

                    if (localPriceSettings) {
                        this.data.priceSettings = JSON.parse(localPriceSettings);
                    } else {
                        const priceSettings = await this.loadData('price_settings.json');
                        this.data.priceSettings = priceSettings || [];
                    }

                    if (localPromotions) {
                        this.data.promotions = JSON.parse(localPromotions);
                    } else {
                        const promotions = await this.loadData('promotions.json');
                        this.data.promotions = promotions || [];
                    }

                    // Load colors with proper fallback
                    const localColors = localStorage.getItem('moveisbonafe_colors');
                    if (localColors) {
                        this.data.colors = JSON.parse(localColors);
                        console.log(`🎨 Carregado ${this.data.colors.length} cores do localStorage`);
                    } else {
                        const colors = await this.loadData('colors.json');
                        this.data.colors = colors || [];
                        console.log(`🎨 Carregado ${this.data.colors.length} cores do GitHub`);
                        // Save to localStorage for next time
                        if (this.data.colors.length > 0) {
                            localStorage.setItem('moveisbonafe_colors', JSON.stringify(this.data.colors));
                        }
                    }

                    console.log(`✅ Dados carregados: ${this.data.products.length} produtos, ${this.data.categories.length} categorias, ${this.data.colors.length} cores, ${this.data.users.length} usuários, ${this.data.priceSettings.length} tabelas de preço, ${this.data.promotions.length} promoções`);
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                }
            }

            renderProducts() {
                const loading = document.getElementById('produtos-loading');
                const content = document.getElementById('produtos-content');
                const table = document.getElementById('produtos-table');
                const empty = document.getElementById('produtos-empty');

                loading.style.display = 'none';
                content.style.display = 'block';

                if (this.data.products.length === 0) {
                    table.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                table.innerHTML = '';

                this.data.products.forEach((product, index) => {
                    const row = table.insertRow();
                    const basePrice = product.priceAVista || product.basePrice || product.finalPrice || 0;
                    
                    // Calculate prices using actual price settings multipliers
                    const priceSettings = this.data.priceSettings.sort((a, b) => a.percentage - b.percentage);
                    const calculatedPrices = [];
                    
                    priceSettings.forEach(setting => {
                        const multiplier = 1 + (setting.percentage / 100);
                        const finalPrice = (basePrice * multiplier).toFixed(2);
                        calculatedPrices.push(finalPrice);
                    });
                    
                    // Ensure we have at least 5 price columns, fill with base price if needed
                    while (calculatedPrices.length < 5) {
                        calculatedPrices.push(basePrice.toFixed(2));
                    }
                    
                    // Generate product image display with SVG fallback
                    let imageCell = `
                        <div class="product-image-cell">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="32" height="32" fill="#f3f4f6"/>
                                <path d="M8 8h16v16H8V8z" fill="#d1d5db"/>
                                <circle cx="13" cy="13" r="2" fill="#9ca3af"/>
                                <path d="M8 20l4-4 3 3 5-5 4 4v2H8v-2z" fill="#9ca3af"/>
                            </svg>
                        </div>
                    `;
                    
                    // Handle multiple images - prioritize first image from images array
                    const images = product.images || (product.imageFile ? [product.imageFile] : []);
                    if (images.length > 0) {
                        let imageSrc = images[0];
                        
                        // Use GitHub Pages URLs for all images
                        imageSrc = imageSrc.startsWith('data/images/') ? 
                            `${this.baseUrl}/${imageSrc}` : 
                            `${this.baseUrl}/data/images/${imageSrc.replace(/^data\/images\//, '')}`;
                        
                        const imageCount = images.length > 1 ? `<span class="image-count">+${images.length - 1}</span>` : '';
                        
                        imageCell = `
                            <div class="product-image-cell">
                                <img src="${imageSrc}" 
                                     alt="${product.name}" 
                                     class="product-thumbnail"
                                     onerror="this.parentNode.innerHTML='<svg width=\\"32\\" height=\\"32\\" viewBox=\\"0 0 32 32\\" fill=\\"none\\"><rect width=\\"32\\" height=\\"32\\" fill=\\"#f3f4f6\\"/><path d=\\"M8 8h16v16H8V8z\\" fill=\\"#d1d5db\\"/><circle cx=\\"13\\" cy=\\"13\\" r=\\"2\\" fill=\\"#9ca3af\\"/><path d=\\"M8 20l4-4 3 3 5-5 4 4v2H8v-2z\\" fill=\\"#9ca3af\\"/></svg>';">
                                ${imageCount}
                            </div>
                        `;
                    }
                    
                    row.innerHTML = `
                        <td>${imageCell}</td>
                        <td><strong>${product.name || 'Sem nome'}</strong><br><small>${product.category || 'Sem categoria'}</small></td>
                        <td class="price-cell">R$ ${calculatedPrices[0]}</td>
                        <td class="price-cell">R$ ${calculatedPrices[1]}</td>
                        <td class="price-cell">R$ ${calculatedPrices[2]}</td>
                        <td class="price-cell">R$ ${calculatedPrices[3]}</td>
                        <td class="price-cell">R$ ${calculatedPrices[4]}</td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editProduct(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteProduct(${index})">🗑️</button>
                        </td>
                    `;
                });
            }

            renderCategories() {
                const loading = document.getElementById('categorias-loading');
                const content = document.getElementById('categorias-content');
                const table = document.getElementById('categorias-table');

                loading.style.display = 'none';
                content.style.display = 'block';
                table.innerHTML = '';

                this.data.categories.forEach((category, index) => {
                    const productCount = this.data.products.filter(p => p.category === category.name).length;
                    const row = table.insertRow();
                    
                    // Handle category image display
                    let categoryImageCell = '<div class="category-image-placeholder">📦</div>';
                    if (category.imageFile) {
                        let imageSrc = category.imageFile;
                        
                        // Use GitHub Pages URLs for all images
                        const githubImageSrc = imageSrc.startsWith('data/images/') ? 
                            `${this.baseUrl}/${imageSrc}` : 
                            `${this.baseUrl}/data/images/${imageSrc.replace(/^data\/images\//, '')}`;
                        categoryImageCell = `<img src="${githubImageSrc}" alt="${category.name}" class="category-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="category-image-placeholder" style="display: none;">📦</div>`;
                    }
                    
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${categoryImageCell}
                                <strong>${category.name || 'Sem nome'}</strong>
                            </div>
                        </td>
                        <td>${category.description || 'Sem descrição'}</td>
                        <td><span style="background: ${category.color || '#ccc'}; padding: 4px 8px; border-radius: 4px; color: white;">${category.color || 'N/A'}</span></td>
                        <td>${productCount} produtos</td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editCategory(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteCategory(${index})">🗑️</button>
                        </td>
                    `;
                });

                // Update product category dropdown
                const categorySelect = document.getElementById('product-category');
                categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                this.data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }

            renderUsers() {
                const loading = document.getElementById('usuarios-loading');
                const content = document.getElementById('usuarios-content');
                const table = document.getElementById('usuarios-table');

                loading.style.display = 'none';
                content.style.display = 'block';
                table.innerHTML = '';

                this.data.users.forEach((user, index) => {
                    const row = table.insertRow();
                    const isActive = user.active !== false;
                    
                    row.innerHTML = `
                        <td><strong>${user.name || 'Sem nome'}</strong></td>
                        <td>${user.username || 'Sem username'}</td>
                        <td>${user.role || 'Sem função'}</td>
                        <td>${(user.priceMultiplier || 1.0).toFixed(2)}x</td>
                        <td><span style="background: ${isActive ? '#5cb85c' : '#e74c3c'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${isActive ? 'Ativo' : 'Inativo'}</span></td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editUser(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteUser(${index})">🗑️</button>
                        </td>
                    `;
                });
            }

            renderPriceSettings() {
                const loading = document.getElementById('precos-loading');
                const content = document.getElementById('precos-content');
                const table = document.getElementById('precos-table');

                loading.style.display = 'none';
                content.style.display = 'block';
                table.innerHTML = '';

                this.data.priceSettings.forEach((setting, index) => {
                    const row = table.insertRow();
                    const multiplier = (1 + (setting.percentage / 100)).toFixed(3);
                    const example = (100 * multiplier).toFixed(2);
                    
                    row.innerHTML = `
                        <td><strong>${setting.tableName}</strong></td>
                        <td>${setting.percentage.toFixed(1)}%</td>
                        <td>${multiplier}x</td>
                        <td class="price-cell">R$ ${example}</td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editPriceSetting(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deletePriceSetting(${index})">🗑️</button>
                        </td>
                    `;
                });
            }

            renderPromotions() {
                const loading = document.getElementById('promocoes-loading');
                const content = document.getElementById('promocoes-content');
                const table = document.getElementById('promocoes-table');

                loading.style.display = 'none';
                content.style.display = 'block';
                table.innerHTML = '';

                this.data.promotions.forEach((promotion, index) => {
                    const row = table.insertRow();
                    const isActive = promotion.active === true;
                    
                    row.innerHTML = `
                        <td><strong>${promotion.title || 'Sem título'}</strong></td>
                        <td>${promotion.description || 'Sem descrição'}</td>
                        <td><span style="background: ${promotion.color || '#f39c12'}; padding: 4px 8px; border-radius: 4px; color: white;">${promotion.color || 'N/A'}</span></td>
                        <td><span style="background: ${isActive ? '#5cb85c' : '#e74c3c'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${isActive ? 'Ativa' : 'Inativa'}</span></td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editPromotion(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deletePromotion(${index})">🗑️</button>
                        </td>
                    `;
                });
            }

            renderColors() {
                const loading = document.getElementById('cores-loading');
                const content = document.getElementById('cores-content');
                const table = document.getElementById('cores-table');
                const empty = document.getElementById('cores-empty');

                loading.style.display = 'none';
                content.style.display = 'block';

                if (this.data.colors.length === 0) {
                    table.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                table.innerHTML = '';

                this.data.colors.forEach((color, index) => {
                    const row = table.insertRow();
                    
                    row.innerHTML = `
                        <td><strong>${color.name}</strong></td>
                        <td>
                            <div style="width: 30px; height: 30px; background-color: ${color.code}; border: 1px solid #ddd; border-radius: 4px; display: inline-block;"></div>
                        </td>
                        <td><code>${color.code}</code></td>
                        <td class="action-buttons-cell">
                            <button class="btn btn-edit btn-sm" onclick="editColor(${index})">✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteColor(${index})">🗑️</button>
                        </td>
                    `;
                });
            }

            updateMonitorData() {
                // Update monitor statistics
                const activeProducts = this.data.products.filter(p => p.active !== false).length;
                const activeUsers = this.data.users.filter(u => u.active !== false).length;
                const activePromotions = this.data.promotions.filter(p => p.active === true).length;

                document.getElementById('monitor-products').textContent = activeProducts;
                document.getElementById('monitor-categories').textContent = this.data.categories.length;
                document.getElementById('monitor-users').textContent = activeUsers;
                document.getElementById('monitor-promotions').textContent = activePromotions;

                // Update backup info
                const totalRecords = this.data.products.length + this.data.categories.length + this.data.users.length + this.data.priceSettings.length + this.data.promotions.length;
                const dataSize = JSON.stringify(this.data).length;

                document.getElementById('total-records').textContent = totalRecords.toLocaleString();
                document.getElementById('data-size').textContent = (dataSize / 1024).toFixed(1) + ' KB';
                document.getElementById('last-backup-date').textContent = new Date().toLocaleString('pt-BR');
            }

            // GitHub API Integration
            async saveToGitHub(filename, data) {
                const token = localStorage.getItem('github_token');
                if (!token) {
                    this.requestGitHubToken();
                    return false;
                }

                // Validate token first
                const isValid = await this.validateGitHubToken(token);
                if (!isValid) {
                    console.log('❌ Token inválido, solicitando novo token');
                    this.requestGitHubToken();
                    return false;
                }

                try {
                    // Buscar SHA atual do arquivo
                    const sha = await this.getFileSHA(filename, token);
                    
                    // Preparar conteúdo com codificação UTF-8 correta para português brasileiro
                    const jsonContent = JSON.stringify(data, null, 2);
                    const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                    
                    const requestBody = {
                        message: `Update ${filename} via admin panel - ${new Date().toISOString()}`,
                        content: encodedContent
                    };
                    
                    // Adicionar SHA se arquivo existe
                    if (sha) {
                        requestBody.sha = sha;
                    }

                    const response = await fetch(`https://api.github.com/repos/${this.getRepoPath()}/contents/docs/data/${filename}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(`✅ ${filename} salvo no GitHub (SHA: ${result.content.sha.substring(0,8)})`);
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error(`❌ GitHub API Error ${response.status}:`, errorData);
                        throw new Error(`GitHub API error: ${response.status} - ${errorData.message}`);
                    }
                } catch (error) {
                    console.error(`❌ Erro ao salvar no GitHub:`, error);
                    return false;
                }
            }

            async validateGitHubToken(token) {
                try {
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            }

            async getFileSHA(filename, token) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.getRepoPath()}/contents/docs/data/${filename}`, {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`📁 SHA atual: ${data.sha.substring(0,8)} para ${filename}`);
                        return data.sha;
                    } else if (response.status === 404) {
                        console.log(`📄 Arquivo ${filename} não existe, será criado`);
                        return null;
                    } else {
                        console.error(`Erro ao buscar SHA: ${response.status}`);
                        return null;
                    }
                } catch (error) {
                    console.log(`Erro ao verificar arquivo ${filename}:`, error);
                    return null;
                }
            }

            getRepoPath() {
                // Extract repository path from current URL
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;
                
                if (hostname.includes('github.io')) {
                    const parts = hostname.split('.');
                    const username = parts[0];
                    
                    // For GitHub Pages, repository name is in pathname
                    const pathParts = pathname.split('/').filter(p => p);
                    const repoName = pathParts[0] || username + '.github.io';
                    
                    console.log(`🔗 Detectado repositório: ${username}/${repoName}`);
                    return `${username}/${repoName}`;
                }
                
                // Fallback para desenvolvimento local/Replit
                console.log('🔗 Usando repositório padrão para desenvolvimento');
                return 'moveisbonafe/TabelaPrecoMoveisBonafe';
            }

            base64EncodeUTF8(str) {
                // Properly encode UTF-8 strings for GitHub API
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }

            requestGitHubToken() {
                const token = prompt(`Para salvar dados no GitHub, insira seu Personal Access Token:

1. Vá para GitHub.com → Settings → Developer settings → Personal access tokens
2. Generate new token (classic)
3. Selecione escopo 'repo'
4. Cole o token abaixo:

O token será salvo localmente no navegador.`);

                if (token && token.trim()) {
                    localStorage.setItem('github_token', token.trim());
                    alert('Token GitHub salvo com sucesso!');
                    console.log('🔑 GitHub token updated');
                } else {
                    alert('Token necessário para salvar alterações.');
                }
            }
            
            configureGitHubToken() {
                this.requestGitHubToken();
            }

            saveData(type, data) {
                this.data[type] = data;
                
                // Sempre salvar no localStorage primeiro para persistência imediata
                localStorage.setItem(`moveisbonafe_${type}`, JSON.stringify(data));
                
                // Notificar outros dispositivos sobre a mudança
                this.notifyDataChange(type, data);
                
                // Tentar salvar no GitHub se token disponível
                const token = localStorage.getItem('github_token');
                if (token) {
                    const filename = `${type}.json`;
                    this.saveToGitHub(filename, data).then(success => {
                        if (success) {
                            console.log(`✅ ${type} salvo no GitHub`);
                        } else {
                            console.log(`❌ Erro ao salvar ${type} no GitHub, mantido localmente`);
                        }
                    });
                } else {
                    console.log(`${type} salvo apenas localmente (token GitHub não configurado)`);
                }
            }

            notifyDataChange(type, data) {
                // Disparar evento customizado para notificar mudanças
                const timestamp = Date.now();
                localStorage.setItem(`moveisbonafe_sync_${type}`, timestamp.toString());
                
                // Criar um identificador único para forçar a sincronização
                localStorage.setItem(`moveisbonafe_force_sync`, timestamp.toString());
                
                // Evento de mudança para sincronização cross-tab
                window.dispatchEvent(new CustomEvent('moveisbonafe_data_update', {
                    detail: { type, data, timestamp }
                }));
                
                // Broadcast via localStorage para garantir sincronização
                localStorage.setItem(`moveisbonafe_broadcast_${type}`, JSON.stringify({ data, timestamp }));
                
                console.log(`📢 Notificação enviada: ${type} atualizado`);
            }
        }

        // Global variables
        let adminClient;

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Modal management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            
            // Clear form data and datasets when closing
            if (modalId === 'product-modal') {
                const form = document.getElementById('product-form');
                form.reset();
                delete form.dataset.imageFile;
                delete form.dataset.images;
                delete modal.dataset.editIndex;
                const preview = document.getElementById('product-image-preview');
                if (preview) preview.innerHTML = '';
                const gallery = document.getElementById('product-image-gallery');
                if (gallery) gallery.innerHTML = '';
            } else if (modalId === 'category-modal') {
                const form = document.getElementById('category-form');
                form.reset();
                delete form.dataset.imageFile;
                delete modal.dataset.editIndex;
                const preview = document.getElementById('category-image-preview');
                if (preview) preview.innerHTML = '';
            } else if (modalId === 'user-modal') {
                const form = document.getElementById('user-form');
                form.reset();
                delete modal.dataset.editIndex;
            }
        }

        function openProductModal(productIndex = null) {
            const modal = document.getElementById('product-modal');
            const title = document.querySelector('#product-modal .modal-title');
            
            if (productIndex !== null) {
                title.textContent = 'Editar Produto';
                const product = adminClient.data.products[productIndex];
                document.getElementById('product-name').value = product.name || '';
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-price').value = product.priceAVista || product.basePrice || 0;
                
                // Preencher novos campos do modelo Excel
                document.getElementById('product-altura').value = product.altura || 0;
                document.getElementById('product-largura').value = product.largura || 0;
                document.getElementById('product-comprimento').value = product.comprimento || 0;
                document.getElementById('product-peso').value = product.peso || 0;
                document.getElementById('product-description').value = product.description || '';
                
                // Load existing images
                loadExistingImages(product);
                
                // Load existing colors
                loadExistingColors(product);
                
                modal.dataset.editIndex = productIndex;
            } else {
                title.textContent = 'Adicionar Produto';
                document.getElementById('product-form').reset();
                clearImagePreviews();
                clearColorVariations();
                delete modal.dataset.editIndex;
            }
            
            openModal('product-modal');
        }

        function openCategoryModal(categoryIndex = null) {
            const modal = document.getElementById('category-modal');
            const title = document.querySelector('#category-modal .modal-title');
            
            if (categoryIndex !== null) {
                title.textContent = 'Editar Categoria';
                const category = adminClient.data.categories[categoryIndex];
                document.getElementById('category-name').value = category.name || '';
                document.getElementById('category-description').value = category.description || '';
                document.getElementById('category-color').value = category.color || '#4a90e2';
                
                // Load existing category image
                loadExistingCategoryImage(category);
                
                modal.dataset.editIndex = categoryIndex;
            } else {
                title.textContent = 'Adicionar Categoria';
                document.getElementById('category-form').reset();
                clearCategoryImagePreviews();
                delete modal.dataset.editIndex;
            }
            
            openModal('category-modal');
        }

        function openUserModal(userIndex = null) {
            const modal = document.getElementById('user-modal');
            const title = document.querySelector('#user-modal .modal-title');
            
            if (userIndex !== null) {
                title.textContent = 'Editar Usuário';
                const user = adminClient.data.users[userIndex];
                document.getElementById('user-name').value = user.name || '';
                document.getElementById('user-username').value = user.username || '';
                document.getElementById('user-password').value = user.passwordHash || '';
                document.getElementById('user-role').value = user.role || '';
                document.getElementById('user-multiplier').value = user.priceMultiplier || 1.0;
                modal.dataset.editIndex = userIndex;
            } else {
                title.textContent = 'Adicionar Usuário';
                document.getElementById('user-form').reset();
                document.getElementById('user-multiplier').value = '1.00';
                delete modal.dataset.editIndex;
            }
            
            openModal('user-modal');
        }

        // CRUD operations (GitHub Pages limitation - read-only)
        function editProduct(index) {
            openProductModal(index);
        }

        function deleteProduct(index) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                // Get the product being deleted
                const productToDelete = adminClient.data.products[index];
                console.log(`🗑️ Deletando produto: ${productToDelete.name}`);
                
                // Remove from data array
                adminClient.data.products.splice(index, 1);
                
                // Save immediately to localStorage and GitHub
                adminClient.saveData('products', adminClient.data.products);
                
                // Re-render the table
                adminClient.renderProducts();
                
                // Add log for monitoring
                addSystemLog(`Produto "${productToDelete.name}" deletado`);
                
                console.log(`✅ Produto deletado. Total restante: ${adminClient.data.products.length}`);
            }
        }

        function editCategory(index) {
            openCategoryModal(index);
        }

        function deleteCategory(index) {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                adminClient.data.categories.splice(index, 1);
                adminClient.saveData('categories', adminClient.data.categories);
                adminClient.renderCategories();
            }
        }

        function editUser(index) {
            openUserModal(index);
        }

        function deleteUser(index) {
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                adminClient.data.users.splice(index, 1);
                adminClient.saveData('users', adminClient.data.users);
                adminClient.renderUsers();
            }
        }

        // Excel and File Operations
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                // Handle Excel files
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        parseExcelData(jsonData);
                    } catch (error) {
                        console.error('Erro ao processar arquivo Excel:', error);
                        alert('Erro ao processar arquivo Excel. Verifique se o arquivo não está corrompido.');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.csv')) {
                // Handle CSV files
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        parseCSVData(data);
                    } catch (error) {
                        console.error('Erro ao processar arquivo CSV:', error);
                        alert('Erro ao processar arquivo CSV. Verifique o formato.');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                alert('Formato não suportado. Use arquivos .xlsx, .xls ou .csv');
            }
        }

        function parseExcelData(excelData) {
            if (!excelData || excelData.length < 2) {
                alert('Arquivo Excel vazio ou inválido.');
                return;
            }
            
            const headers = excelData[0];
            const expectedHeaders = ['Nome', 'Categoria', 'Preço', 'Altura', 'Largura', 'Comprimento', 'Peso', 'Descrição'];
            
            // Check if headers match (case insensitive)
            const headerMap = {};
            headers.forEach((header, index) => {
                if (header) {
                    const normalizedHeader = header.toString().trim().toLowerCase();
                    expectedHeaders.forEach(expected => {
                        if (normalizedHeader === expected.toLowerCase()) {
                            headerMap[expected] = index;
                        }
                    });
                }
            });
            
            console.log('Headers encontrados:', headers);
            console.log('Mapeamento de colunas:', headerMap);
            
            if (Object.keys(headerMap).length < 3) {
                alert('Formato inválido. Certifique-se que o arquivo Excel contém pelo menos: Nome, Categoria, Preço\n\nColunas encontradas: ' + headers.join(', ') + '\n\nMapeamento: ' + JSON.stringify(headerMap));
                return;
            }

            const newProducts = [];
            const updatedProducts = [];
            
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (!row || row.length === 0) continue;
                
                const name = row[headerMap['Nome']]?.toString().trim();
                if (!name) continue; // Skip empty rows
                
                // Parse price with better error handling and debugging
                const priceValue = row[headerMap['Preço']];
                let parsedPrice = 0;
                
                console.log(`Debug - Produto: "${name}", Preço raw:`, priceValue);
                
                if (priceValue !== undefined && priceValue !== null && priceValue !== '') {
                    const priceStr = priceValue.toString().trim()
                        .replace('R$', '')  // Remove currency symbol
                        .replace(/\s/g, '') // Remove spaces
                        .replace(',', '.'); // Replace comma with dot
                    
                    parsedPrice = parseFloat(priceStr);
                    if (isNaN(parsedPrice)) {
                        parsedPrice = 0;
                        console.warn(`Preço inválido para produto "${name}": ${priceValue}`);
                    } else {
                        console.log(`Debug - Preço parseado: ${parsedPrice}`);
                    }
                } else {
                    console.warn(`Debug - Preço vazio ou null para produto "${name}"`);
                }
                
                const productData = {
                    name: name,
                    category: row[headerMap['Categoria']]?.toString().trim() || 'Geral',
                    priceAVista: parsedPrice,
                    basePrice: parsedPrice, // Also update basePrice for compatibility
                    finalPrice: parsedPrice, // Also update finalPrice for compatibility
                    altura: parseFloat(row[headerMap['Altura']]?.toString().replace(',', '.')) || 0,
                    largura: parseFloat(row[headerMap['Largura']]?.toString().replace(',', '.')) || 0,
                    comprimento: parseFloat(row[headerMap['Comprimento']]?.toString().replace(',', '.')) || 0,
                    peso: parseFloat(row[headerMap['Peso']]?.toString().replace(',', '.')) || 0,
                    description: row[headerMap['Descrição']]?.toString().trim() || '',
                    active: true,
                    updatedAt: new Date().toISOString()
                };
                
                // Check if product exists by name
                const existingIndex = adminClient.data.products.findIndex(p => 
                    p.name.toLowerCase().trim() === name.toLowerCase().trim()
                );
                
                if (existingIndex !== -1) {
                    // Update existing product
                    const oldPrice = adminClient.data.products[existingIndex].priceAVista || 0;
                    adminClient.data.products[existingIndex] = {
                        ...adminClient.data.products[existingIndex],
                        ...productData,
                        id: adminClient.data.products[existingIndex].id, // Keep original ID
                        createdAt: adminClient.data.products[existingIndex].createdAt // Keep creation date
                    };
                    console.log(`Produto "${name}" atualizado: preço ${oldPrice} → ${parsedPrice}`);
                    updatedProducts.push(name);
                } else {
                    // Add new product
                    const newProduct = {
                        ...productData,
                        id: Date.now() + i,
                        createdAt: new Date().toISOString()
                    };
                    adminClient.data.products.push(newProduct);
                    newProducts.push(name);
                }
            }

            if (newProducts.length > 0 || updatedProducts.length > 0) {
                adminClient.saveData('products', adminClient.data.products);
                adminClient.renderProducts();
                
                let message = '';
                if (newProducts.length > 0) {
                    message += `${newProducts.length} produtos adicionados`;
                }
                if (updatedProducts.length > 0) {
                    if (message) message += ', ';
                    message += `${updatedProducts.length} produtos atualizados`;
                }
                message += ' do arquivo Excel!';
                
                alert(message);
                addSystemLog(`Excel: ${newProducts.length} novos, ${updatedProducts.length} atualizados`);
            } else {
                alert('Nenhum produto válido encontrado no arquivo Excel.');
            }
        }

        function parseCSVData(csvData) {
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('Arquivo vazio ou inválido.');
                return;
            }
            
            // Auto-detect separator (tab or comma)
            let separator = ',';
            if (lines[0].includes('\t')) {
                separator = '\t';
            }
            
            const headers = lines[0].split(separator).map(h => h.trim());
            const expectedHeaders = ['Nome', 'Categoria', 'Preço', 'Altura', 'Largura', 'Comprimento', 'Peso', 'Descrição'];
            
            // Check if headers match (case insensitive)
            const headerMap = {};
            headers.forEach((header, index) => {
                const normalizedHeader = header.trim().toLowerCase();
                expectedHeaders.forEach(expected => {
                    if (normalizedHeader === expected.toLowerCase()) {
                        headerMap[expected] = index;
                    }
                });
            });
            
            if (Object.keys(headerMap).length < 3) {
                alert('Formato inválido. Certifique-se que o arquivo contém pelo menos: Nome, Categoria, Preço');
                return;
            }

            const products = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                
                const name = values[headerMap['Nome']]?.trim();
                if (!name) continue; // Skip empty rows
                
                // Parse price with better error handling
                const priceValue = values[headerMap['Preço']];
                let parsedPrice = 0;
                
                if (priceValue !== undefined && priceValue !== null && priceValue !== '') {
                    const priceStr = priceValue.toString().trim()
                        .replace('R$', '')  // Remove currency symbol
                        .replace(/\s/g, '') // Remove spaces
                        .replace(',', '.'); // Replace comma with dot
                    
                    parsedPrice = parseFloat(priceStr);
                    if (isNaN(parsedPrice)) {
                        parsedPrice = 0;
                        console.warn(`Preço inválido para produto "${name}": ${priceValue}`);
                    }
                }
                
                products.push({
                    id: Date.now() + i,
                    name: name,
                    category: values[headerMap['Categoria']]?.trim() || 'Geral',
                    priceAVista: parsedPrice,
                    basePrice: parsedPrice, // Also update basePrice for compatibility
                    finalPrice: parsedPrice, // Also update finalPrice for compatibility
                    altura: parseFloat(values[headerMap['Altura']]?.replace(',', '.')) || 0,
                    largura: parseFloat(values[headerMap['Largura']]?.replace(',', '.')) || 0,
                    comprimento: parseFloat(values[headerMap['Comprimento']]?.replace(',', '.')) || 0,
                    peso: parseFloat(values[headerMap['Peso']]?.replace(',', '.')) || 0,
                    description: values[headerMap['Descrição']]?.trim() || '',
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }

            if (products.length > 0) {
                adminClient.data.products = [...adminClient.data.products, ...products];
                adminClient.saveData('products', adminClient.data.products);
                adminClient.renderProducts();
                alert(`${products.length} produtos importados com sucesso!`);
                addSystemLog(`${products.length} produtos importados via CSV`);
            } else {
                alert('Nenhum produto válido encontrado no arquivo.');
            }
        }

        function exportToCSV() {
            exportToExcel();
        }

        function exportToExcel() {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Prepare data with proper headers matching your format
            const headers = ['Nome', 'Categoria', 'Preço', 'Altura', 'Largura', 'Comprimento', 'Peso', 'Descrição'];
            const data = [headers];

            adminClient.data.products.forEach(product => {
                data.push([
                    product.name || '',
                    product.category || '',
                    product.priceAVista || 0,
                    product.altura || 0,
                    product.largura || 0,
                    product.comprimento || 0,
                    product.peso || 0,
                    product.description || ''
                ]);
            });

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths for better readability
            ws['!cols'] = [
                { wch: 30 }, // Nome
                { wch: 15 }, // Categoria
                { wch: 12 }, // Preço
                { wch: 10 }, // Altura
                { wch: 10 }, // Largura
                { wch: 12 }, // Comprimento
                { wch: 10 }, // Peso
                { wch: 40 }  // Descrição
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Produtos');
            
            // Generate filename with current date
            const filename = `produtos-moveisbonafe-${new Date().toISOString().split('T')[0]}_${Date.now()}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            addSystemLog('Dados exportados para Excel (.xlsx)');
        }

        function downloadBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: adminClient.data
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `moveisbonafe_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function handleBackupRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.data) {
                        if (confirm('Isso substituirá todos os dados atuais. Continuar?')) {
                            adminClient.data = backup.data;
                            // Save all data types
                            Object.keys(adminClient.data).forEach(type => {
                                adminClient.saveData(type, adminClient.data[type]);
                            });
                            location.reload();
                        }
                    } else {
                        alert('Arquivo de backup inválido.');
                    }
                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    alert('Erro ao processar backup. Verifique o arquivo.');
                }
            };
            reader.readAsText(file);
        }

        // Price Settings Functions
        function openPriceModal(index = null) {
            // Create price modal if it doesn't exist
            if (!document.getElementById('price-modal')) {
                const modalHTML = `
                    <div id="price-modal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Adicionar Tabela de Preço</h3>
                                <button class="close-btn" onclick="closeModal('price-modal')">&times;</button>
                            </div>
                            <form id="price-form">
                                <div class="form-group">
                                    <label class="form-label">Nome da Tabela</label>
                                    <input type="text" class="form-input" id="price-name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Percentual (%)</label>
                                    <input type="number" class="form-input" id="price-percentage" step="0.1" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-cancel" onclick="closeModal('price-modal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                document.getElementById('price-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    savePriceSetting();
                });
            }

            const modal = document.getElementById('price-modal');
            const title = document.querySelector('#price-modal .modal-title');
            
            if (index !== null) {
                title.textContent = 'Editar Tabela de Preço';
                const setting = adminClient.data.priceSettings[index];
                document.getElementById('price-name').value = setting.tableName || '';
                document.getElementById('price-percentage').value = setting.percentage || 0;
                modal.dataset.editIndex = index;
            } else {
                title.textContent = 'Adicionar Tabela de Preço';
                document.getElementById('price-form').reset();
                delete modal.dataset.editIndex;
            }
            
            openModal('price-modal');
        }

        function savePriceSetting() {
            const modal = document.getElementById('price-modal');
            const isEdit = modal.dataset.editIndex !== undefined;
            const index = parseInt(modal.dataset.editIndex);

            const setting = {
                id: isEdit ? adminClient.data.priceSettings[index].id : Date.now().toString(),
                tableName: document.getElementById('price-name').value,
                percentage: parseFloat(document.getElementById('price-percentage').value),
                active: true,
                createdAt: isEdit ? adminClient.data.priceSettings[index].createdAt : new Date().toISOString()
            };

            if (isEdit) {
                adminClient.data.priceSettings[index] = setting;
            } else {
                adminClient.data.priceSettings.push(setting);
            }

            adminClient.saveData('priceSettings', adminClient.data.priceSettings);
            adminClient.renderPriceSettings();
            closeModal('price-modal');
        }

        function editPriceSetting(index) {
            openPriceModal(index);
        }

        function deletePriceSetting(index) {
            if (confirm('Tem certeza que deseja excluir esta tabela de preços?')) {
                adminClient.data.priceSettings.splice(index, 1);
                adminClient.saveData('priceSettings', adminClient.data.priceSettings);
                adminClient.renderPriceSettings();
            }
        }

        // Promotion Functions
        function openPromotionModal(index = null) {
            // Create promotion modal if it doesn't exist
            if (!document.getElementById('promotion-modal')) {
                const modalHTML = `
                    <div id="promotion-modal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Adicionar Promoção</h3>
                                <button class="close-btn" onclick="closeModal('promotion-modal')">&times;</button>
                            </div>
                            <form id="promotion-form">
                                <div class="form-group">
                                    <label class="form-label">Texto</label>
                                    <input type="text" class="form-input" id="promotion-title" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Descrição</label>
                                    <textarea class="form-input" id="promotion-description" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cor</label>
                                    <input type="color" class="form-input" id="promotion-color" value="#f39c12">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="promotion-active"> Ativar promoção
                                    </label>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-cancel" onclick="closeModal('promotion-modal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                document.getElementById('promotion-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    savePromotion();
                });
            }

            const modal = document.getElementById('promotion-modal');
            const title = document.querySelector('#promotion-modal .modal-title');
            
            if (index !== null) {
                title.textContent = 'Editar Promoção';
                const promotion = adminClient.data.promotions[index];
                document.getElementById('promotion-title').value = promotion.title || '';
                document.getElementById('promotion-description').value = promotion.description || '';
                document.getElementById('promotion-color').value = promotion.color || '#f39c12';
                document.getElementById('promotion-active').checked = promotion.active === true;
                modal.dataset.editIndex = index;
            } else {
                title.textContent = 'Adicionar Promoção';
                document.getElementById('promotion-form').reset();
                document.getElementById('promotion-color').value = '#f39c12';
                delete modal.dataset.editIndex;
            }
            
            openModal('promotion-modal');
        }

        function savePromotion() {
            const modal = document.getElementById('promotion-modal');
            const isEdit = modal.dataset.editIndex !== undefined;
            const index = parseInt(modal.dataset.editIndex);
            const isActive = document.getElementById('promotion-active').checked;

            // If activating this promotion, deactivate others
            if (isActive) {
                adminClient.data.promotions.forEach(p => p.active = false);
            }

            const promotion = {
                id: isEdit ? adminClient.data.promotions[index].id : Date.now().toString(),
                title: document.getElementById('promotion-title').value,
                description: document.getElementById('promotion-description').value,
                color: document.getElementById('promotion-color').value,
                active: isActive,
                createdAt: isEdit ? adminClient.data.promotions[index].createdAt : new Date().toISOString()
            };

            if (isEdit) {
                adminClient.data.promotions[index] = promotion;
            } else {
                adminClient.data.promotions.push(promotion);
            }

            adminClient.saveData('promotions', adminClient.data.promotions);
            adminClient.renderPromotions();
            adminClient.updateMonitorData();
            closeModal('promotion-modal');
        }

        function editPromotion(index) {
            openPromotionModal(index);
        }

        function deletePromotion(index) {
            if (confirm('Tem certeza que deseja excluir esta promoção?')) {
                adminClient.data.promotions.splice(index, 1);
                adminClient.saveData('promotions', adminClient.data.promotions);
                adminClient.renderPromotions();
                adminClient.updateMonitorData();
            }
        }

        // Image Upload Functions
        async function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (file.size > 2 * 1024 * 1024) {
                alert('Arquivo muito grande. Máximo 2MB.');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Arquivo deve ser uma imagem.');
                return;
            }

            // Upload file to server
            const formData = new FormData();
            formData.append('image', file);
            formData.append('type', type);

            try {
                const response = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const imagePath = result.path;
                    
                    if (type === 'product') {
                        // Update form with image path reference
                        const form = document.getElementById('product-form');
                        let existingImages = form.dataset.images ? JSON.parse(form.dataset.images) : [];
                        existingImages.push(imagePath);
                        form.dataset.images = JSON.stringify(existingImages);
                        
                        // Show preview in gallery
                        addImageToGallery(result.url, result.filename, 'product-image-gallery');
                    } else if (type === 'category') {
                        const form = document.getElementById('category-form');
                        form.dataset.imageFile = imagePath;
                        
                        showImagePreview(result.url, 'category-image');
                    }

                    console.log(`Imagem ${result.filename} enviada com sucesso: ${imagePath}`);
                } else {
                    alert('Erro ao enviar imagem: ' + result.error);
                }
            } catch (error) {
                console.error('Erro no upload:', error);
                alert('Erro ao enviar imagem. Tente novamente.');
            }
        }

        function addImageToGallery(imageUrl, fileName, galleryId) {
            let gallery = document.getElementById(galleryId);
            if (!gallery) {
                // Create gallery if it doesn't exist
                gallery = document.createElement('div');
                gallery.id = galleryId;
                gallery.className = 'image-gallery';
                gallery.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    margin-top: 12px;
                    padding: 12px;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    background: #f8f9fa;
                `;
                
                // Try to find a suitable container for the gallery
                const input = document.getElementById('product-image') || document.getElementById('edit-product-image');
                const modalContent = document.querySelector('.modal-content');
                const productForm = document.getElementById('product-form');
                
                if (input && input.parentNode) {
                    input.parentNode.insertBefore(gallery, input.nextSibling);
                } else if (modalContent) {
                    modalContent.appendChild(gallery);
                } else if (productForm) {
                    productForm.appendChild(gallery);
                } else {
                    // Last resort: append to body
                    document.body.appendChild(gallery);
                }
            }
            
            const imageItem = document.createElement('div');
            imageItem.className = 'gallery-item';
            imageItem.style.cssText = `
                position: relative;
                width: 80px;
                height: 80px;
                border-radius: 6px;
                overflow: hidden;
                border: 2px solid #ddd;
            `;
            
            imageItem.innerHTML = `
                <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                <button onclick="removeImageFromGallery('${fileName}', this)" 
                        style="position: absolute; top: 2px; right: 2px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
            `;
            
            gallery.appendChild(imageItem);
        }

        function removeImageFromGallery(fileName, button) {
            // Remove from localStorage
            localStorage.removeItem(`image_${fileName}`);
            
            // Remove from form data
            const form = document.getElementById('product-form');
            let existingImages = form.dataset.images ? JSON.parse(form.dataset.images) : [];
            existingImages = existingImages.filter(img => img !== fileName);
            form.dataset.images = JSON.stringify(existingImages);
            
            // Remove from DOM
            button.parentElement.remove();
        }

        function showImagePreview(imageUrl, inputId) {
            const input = document.getElementById(inputId);
            let preview = input.parentNode.querySelector('.image-preview');
            
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.cssText = `
                    margin-top: 8px; 
                    max-width: 120px; 
                    max-height: 120px; 
                    overflow: hidden; 
                    border-radius: 8px; 
                    border: 2px solid #e0e0e0;
                    background: #f8f9fa;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                input.parentNode.insertBefore(preview, input.nextSibling);
            }
            
            preview.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
        }

        // Monitor tab real-time updates
        function startMonitorUpdates() {
            setInterval(() => {
                if (adminClient && document.querySelector('#monitor-tab.active')) {
                    adminClient.updateMonitorData();
                }
            }, 30000); // Update every 30 seconds
        }

        // System logs simulation for monitor
        function addSystemLog(message) {
            const logs = JSON.parse(localStorage.getItem('system_logs') || '[]');
            const timestamp = new Date().toLocaleString('pt-BR');
            logs.unshift(`${timestamp} - ${message}`);
            
            // Keep only last 50 logs
            if (logs.length > 50) {
                logs.splice(50);
            }
            
            localStorage.setItem('system_logs', JSON.stringify(logs));
        }

        // Color variation management
        function addColorVariation() {
            const colorList = document.getElementById('color-list');
            const colorId = Date.now();
            
            const colorItem = document.createElement('div');
            colorItem.style.cssText = `
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            `;
            colorItem.id = `color-${colorId}`;
            
            colorItem.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 12px; color: #666;">Nome da Cor</label>
                    <input type="text" placeholder="ex: Imbuia" 
                           style="width: 120px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                           class="color-name">
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                    <label style="font-size: 12px; color: #666;">Cor</label>
                    <input type="color" value="#8B4513"
                           style="width: 50px; height: 35px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;"
                           class="color-picker">
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 12px; color: #666;">Imagem (Opcional)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="file" accept="image/*" 
                               style="width: 150px; font-size: 11px; padding: 4px;"
                               class="color-image" onchange="handleColorImageUpload(event, '${colorId}')">
                        <div class="color-preview" id="preview-${colorId}" 
                             style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; display: none; background-size: cover; background-position: center;">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="removeColorVariation('${colorId}')" 
                        style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; height: fit-content;">
                    Remover
                </button>
            `;
            
            colorList.appendChild(colorItem);
        }

        function removeColorVariation(colorId) {
            const colorItem = document.getElementById(`color-${colorId}`);
            if (colorItem) {
                colorItem.remove();
            }
        }

        function handleColorImageUpload(event, colorId) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('Arquivo muito grande. Máximo 2MB.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileName = `color_${colorId}_${Date.now()}.${file.name.split('.').pop()}`;
                localStorage.setItem(`image_${fileName}`, e.target.result);
                
                // Store reference in the color item
                const colorItem = document.getElementById(`color-${colorId}`);
                colorItem.dataset.imageFile = fileName;
                
                // Show preview
                const preview = document.getElementById(`preview-${colorId}`);
                if (preview) {
                    preview.style.display = 'block';
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.title = 'Imagem carregada com sucesso';
                }
                
                console.log(`✅ Imagem da cor ${fileName} salva e preview exibido`);
            };
            reader.readAsDataURL(file);
        }

        // Handle image upload for products and categories (GitHub Pages - disabled)
        function handleImageUpload(event, type) {
            alert('Upload de imagens não disponível no GitHub Pages. Use a versão local para fazer uploads.');
            event.target.value = '';
        }

        // Process image and upload to GitHub data/images folder
        async function processAndUploadImage(file, type) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = async function() {
                // Set canvas size for high quality
                const maxWidth = 1200;
                const maxHeight = 1200;
                let { width, height } = img;
                
                // Maintain aspect ratio
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw image with high quality settings
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to high quality format
                const imageFormat = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                const quality = imageFormat === 'image/jpeg' ? 0.9 : 1.0; // High quality JPEG or lossless PNG
                
                canvas.toBlob(async (blob) => {
                    const timestamp = Date.now();
                    const extension = imageFormat === 'image/png' ? 'png' : 'jpg';
                    const fileName = `${type}_${timestamp}.${extension}`;
                    
                    // Upload to GitHub data/images folder
                    const success = await uploadImageToGitHub(blob, fileName);
                    
                    if (success) {
                        const form = document.getElementById(`${type}-form`);
                        form.dataset.imageFile = `data/images/${fileName}`;
                        
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            showImagePreview(e.target.result, type);
                        };
                        reader.readAsDataURL(blob);
                        
                        alert('Imagem salva com sucesso!');
                        addSystemLog(`Imagem ${fileName} salva no GitHub`);
                    } else {
                        alert('Erro ao salvar imagem. Verifique o token GitHub.');
                    }
                }, imageFormat, quality);
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Upload image to GitHub data/images folder with conflict handling
        async function uploadImageToGitHub(base64Data, fileName) {
            const token = localStorage.getItem('github_token');
            if (!token) {
                alert('Token GitHub necessário para salvar imagens');
                return false;
            }

            // Validate token first
            const isValid = await adminClient.validateGitHubToken(token);
            if (!isValid) {
                alert('Token GitHub inválido ou expirado. Configure um novo token.');
                adminClient.requestGitHubToken();
                return false;
            }
            
            try {
                // Extract base64 data without data:image prefix
                const base64Content = base64Data.split(',')[1];
                
                const repoPath = adminClient.getRepoPath();
                const apiUrl = `https://api.github.com/repos/${repoPath}/contents/docs/data/images/${fileName}`;
                
                // Try to get the existing file to handle conflicts with retry logic
                let sha = null;
                let retries = 3;
                
                while (retries > 0) {
                    try {
                        const existingFile = await fetch(apiUrl, {
                            headers: { 'Authorization': `token ${token}` }
                        });
                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                            console.log(`📝 Arquivo existente encontrado, atualizando: ${fileName} (SHA: ${sha.substring(0,8)})`);
                        } else {
                            console.log(`📁 Novo arquivo: ${fileName}`);
                        }
                        break;
                    } catch (e) {
                        retries--;
                        if (retries > 0) {
                            console.log(`Tentativa de obter SHA falhou, tentando novamente... (${retries} restantes)`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                const body = {
                    message: sha ? `Update image ${fileName}` : `Add image ${fileName}`,
                    content: base64Content
                };
                
                if (sha) {
                    body.sha = sha;
                }
                
                // Retry upload with fresh SHA on conflict
                let uploadRetries = 3;
                
                while (uploadRetries > 0) {
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body)
                    });
                    
                    if (response.ok) {
                        console.log(`✅ Imagem ${fileName} salva no GitHub`);
                        return true;
                    } else if (response.status === 409 && uploadRetries > 1) {
                        console.log(`🔄 Conflito 409 detectado, recarregando SHA e tentando novamente...`);
                        uploadRetries--;
                        
                        // Get fresh SHA for retry
                        try {
                            const freshFile = await fetch(apiUrl, {
                                headers: { 'Authorization': `token ${token}` }
                            });
                            if (freshFile.ok) {
                                const freshData = await freshFile.json();
                                body.sha = freshData.sha;
                                body.message = `Update image ${fileName}`;
                                console.log(`🔄 SHA atualizado: ${freshData.sha.substring(0,8)}`);
                            }
                        } catch (e) {
                            console.log(`Erro ao obter SHA fresco: ${e.message}`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        const errorData = await response.json();
                        console.error(`❌ Erro ao salvar imagem: ${response.status}`, errorData);
                        return false;
                    }
                }
                
                console.error(`❌ Falha após múltiplas tentativas para ${fileName}`);
                return false;
            } catch (error) {
                console.error('Erro ao fazer upload da imagem:', error);
                return false;
            }
        }
        
        function showImagePreview(imageData, type) {
            const previewContainer = document.getElementById(`${type}-image-preview`) || createImagePreview(type);
            previewContainer.innerHTML = `
                <img src="${imageData}" style="max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #ddd;">
                <button type="button" onclick="removeImagePreview('${type}')" style="margin-left: 10px; padding: 2px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Remover</button>
            `;
        }
        
        function createImagePreview(type) {
            const container = document.createElement('div');
            container.id = `${type}-image-preview`;
            container.style.marginTop = '10px';
            
            const input = document.getElementById(`${type}-image`);
            input.parentNode.appendChild(container);
            
            return container;
        }
        
        function removeImagePreview(type) {
            const form = document.getElementById(`${type}-form`);
            if (form) {
                delete form.dataset.imageFile;
            }
            
            const preview = document.getElementById(`${type}-image-preview`);
            if (preview) preview.innerHTML = '';
            
            const input = document.getElementById(`${type}-image`);
            if (input) input.value = '';
        }

        // Configure GitHub Token with status update
        function configureGitHubToken() {
            const currentToken = localStorage.getItem('github_token');
            const message = currentToken ? 
                'Token GitHub já configurado. Deseja alterar?\n\nPara gerar um novo token:\n1. Acesse GitHub.com → Settings → Developer settings\n2. Personal access tokens → Tokens (classic)\n3. Generate new token\n4. Selecione escopo "repo"\n\nNovo token:' :
                'Configure seu GitHub Token para salvar alterações:\n\n1. Acesse GitHub.com → Settings → Developer settings\n2. Personal access tokens → Tokens (classic)\n3. Generate new token\n4. Selecione escopo "repo"\n5. Cole o token abaixo:\n\nToken:';
            
            const token = prompt(message);
            
            if (token && token.trim()) {
                localStorage.setItem('github_token', token.trim());
                updateGitHubTokenStatus();
                alert('Token GitHub configurado com sucesso!\nAgora suas alterações serão salvas no GitHub.');
                addSystemLog('Token GitHub configurado');
            } else if (token === '') {
                localStorage.removeItem('github_token');
                updateGitHubTokenStatus();
                alert('Token GitHub removido. Alterações serão salvas apenas localmente.');
                addSystemLog('Token GitHub removido');
            }
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Form submissions
        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const modal = document.getElementById('product-modal');
            const isEdit = modal.dataset.editIndex !== undefined;
            const index = isEdit ? parseInt(modal.dataset.editIndex) : null;
            
            // Collect color variations
            const colorVariations = [];
            const colorItems = document.querySelectorAll('#color-list > div');
            colorItems.forEach(item => {
                const select = item.querySelector('select');
                if (select && select.value) {
                    colorVariations.push(select.value);
                }
            });

            const product = {
                id: isEdit ? adminClient.data.products[index].id : Date.now().toString(),
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                priceAVista: parseFloat(document.getElementById('product-price').value),
                altura: parseFloat(document.getElementById('product-altura').value) || 0,
                largura: parseFloat(document.getElementById('product-largura').value) || 0,
                comprimento: parseFloat(document.getElementById('product-comprimento').value) || 0,
                peso: parseFloat(document.getElementById('product-peso').value) || 0,
                description: document.getElementById('product-description').value,
                colorVariations: colorVariations,
                active: true,
                createdAt: isEdit ? adminClient.data.products[index].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Handle multiple images using new system
            const form = document.getElementById('product-form');
            
            // Get images from the new gallery system
            if (form.dataset.images) {
                product.images = JSON.parse(form.dataset.images);
            } else if (isEdit) {
                // Preserve existing images for edited products
                const existingProduct = adminClient.data.products[index];
                product.images = existingProduct.images || (existingProduct.imageFile ? [existingProduct.imageFile] : []);
            } else {
                product.images = [];
            }
            
            // Maintain backward compatibility with single imageFile
            if (product.images.length > 0) {
                product.imageFile = product.images[0]; // First image as primary
            } else if (form.dataset.imageFile) {
                // Fallback to old single image system
                product.imageFile = form.dataset.imageFile;
                product.images = [form.dataset.imageFile];
            }
            
            // Save product data immediately
            if (isEdit) {
                adminClient.data.products[index] = product;
            } else {
                adminClient.data.products.push(product);
            }
            
            // Persist data immediately
            adminClient.saveData('products', adminClient.data.products);
            adminClient.renderProducts();
            adminClient.updateMonitorData();
            closeModal('product-modal');
            
            addSystemLog(`${isEdit ? 'Editado' : 'Criado'} produto: ${product.name}`);
        });

        document.getElementById('category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const modal = document.getElementById('category-modal');
            const isEdit = modal.dataset.editIndex !== undefined;
            const index = isEdit ? parseInt(modal.dataset.editIndex) : null;
            
            const category = {
                id: isEdit ? adminClient.data.categories[index].id : Date.now().toString(),
                name: document.getElementById('category-name').value,
                description: document.getElementById('category-description').value,
                color: document.getElementById('category-color').value,
                active: true,
                createdAt: isEdit ? adminClient.data.categories[index].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Handle category image - preserve existing + add new one
            const form = document.getElementById('category-form');
            
            // Start with existing image if editing
            if (isEdit && adminClient.data.categories[index].imageFile) {
                category.imageFile = adminClient.data.categories[index].imageFile;
            }
            
            // Handle new image upload if present
            if (form.dataset.imageFile) {
                category.imageFile = form.dataset.imageFile;
            }
            
            // Save category data immediately
            if (isEdit) {
                adminClient.data.categories[index] = category;
            } else {
                adminClient.data.categories.push(category);
            }
            
            // Persist data immediately
            adminClient.saveData('categories', adminClient.data.categories);
            adminClient.renderCategories();
            adminClient.updateMonitorData();
            closeModal('category-modal');
            
            addSystemLog(`${isEdit ? 'Editada' : 'Criada'} categoria: ${category.name}`);
        });

        document.getElementById('user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const modal = document.getElementById('user-modal');
            const isEdit = modal.dataset.editIndex !== undefined;
            const index = isEdit ? parseInt(modal.dataset.editIndex) : null;
            
            const user = {
                id: isEdit ? adminClient.data.users[index].id : Date.now().toString(),
                name: document.getElementById('user-name').value,
                username: document.getElementById('user-username').value,
                passwordHash: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                priceMultiplier: parseFloat(document.getElementById('user-multiplier').value),
                active: true,
                createdAt: isEdit ? adminClient.data.users[index].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (isEdit) {
                adminClient.data.users[index] = user;
            } else {
                adminClient.data.users.push(user);
            }
            
            adminClient.saveData('users', adminClient.data.users);
            adminClient.renderUsers();
            adminClient.updateMonitorData();
            closeModal('user-modal');
            
            addSystemLog(`${isEdit ? 'Editado' : 'Criado'} usuário: ${user.name}`);
        });

        // Check GitHub token status and update button
        function updateGitHubTokenStatus() {
            const token = localStorage.getItem('github_token');
            const button = document.getElementById('github-token-btn');
            
            if (token) {
                button.style.background = '#28a745';
                button.style.color = 'white';
                button.innerHTML = '✅ GitHub Configurado';
                button.title = 'Token GitHub configurado - Clique para alterar';
            } else {
                button.style.background = '#dc3545';
                button.style.color = 'white';
                button.innerHTML = '⚠️ Configurar GitHub Token';
                button.title = 'IMPORTANTE: Configure o token para salvar alterações';
            }
            
            // Update monitor tab status indicators
            updateMonitorTokenStatus();
        }

        // Update token status in Monitor tab
        function updateMonitorTokenStatus() {
            const token = localStorage.getItem('github_token');
            const statusDot = document.getElementById('github-status-token');
            const statusText = document.getElementById('github-status-token-text');
            const tokenInput = document.getElementById('github-token-input');
            
            if (statusDot && statusText) {
                if (token) {
                    statusDot.style.background = '#5cb85c';
                    statusText.textContent = 'Token válido';
                    statusText.style.color = '#5cb85c';
                    if (tokenInput) {
                        tokenInput.placeholder = '••••••••••••••••••••••••••••••••••••••••• (Configurado)';
                    }
                } else {
                    statusDot.style.background = '#e74c3c';
                    statusText.textContent = 'Token não configurado';
                    statusText.style.color = '#e74c3c';
                    if (tokenInput) {
                        tokenInput.placeholder = 'Cole seu token GitHub aqui';
                    }
                }
            }
        }

        // Save GitHub token from Monitor tab
        function saveGitHubToken() {
            const input = document.getElementById('github-token-input');
            const token = input.value.trim();
            
            if (token) {
                localStorage.setItem('github_token', token);
                input.value = '';
                updateGitHubTokenStatus();
                alert('Token GitHub salvo com sucesso!');
                addSystemLog('Token GitHub configurado via Monitor');
            } else {
                alert('Por favor, insira um token válido.');
            }
        }

        // Color Management Functions
        function openColorModal() {
            document.getElementById('color-modal').style.display = 'flex';
            document.getElementById('color-form').reset();
            document.querySelector('#color-modal .modal-title').textContent = 'Adicionar Cor';
        }

        function editColor(index) {
            const color = adminClient.data.colors[index];
            document.getElementById('color-name').value = color.name;
            document.getElementById('color-code').value = color.code;
            document.querySelector('#color-modal .modal-title').textContent = 'Editar Cor';
            document.getElementById('color-modal').style.display = 'flex';
            document.getElementById('color-form').dataset.editIndex = index;
        }

        function deleteColor(index) {
            if (confirm('Tem certeza que deseja excluir esta cor?')) {
                adminClient.data.colors.splice(index, 1);
                localStorage.setItem('moveisbonafe_colors', JSON.stringify(adminClient.data.colors));
                adminClient.saveData('colors', adminClient.data.colors);
                adminClient.renderColors();
                adminClient.updateMonitorData();
                addSystemLog(`Cor removida`);
            }
        }

        // Color form submission
        document.getElementById('color-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('color-name').value.trim();
            const code = document.getElementById('color-code').value;
            const editIndex = this.dataset.editIndex;
            
            if (!name) {
                alert('Nome da cor é obrigatório');
                return;
            }
            
            const colorData = {
                id: editIndex ? adminClient.data.colors[editIndex].id : Date.now(),
                name: name,
                code: code
            };
            
            if (editIndex !== undefined) {
                adminClient.data.colors[editIndex] = colorData;
                addSystemLog(`Cor editada: ${name}`);
            } else {
                adminClient.data.colors.push(colorData);
                addSystemLog(`Nova cor criada: ${name}`);
            }
            
            // Save to both localStorage and GitHub
            localStorage.setItem('moveisbonafe_colors', JSON.stringify(adminClient.data.colors));
            adminClient.saveData('colors', adminClient.data.colors);
            adminClient.renderColors();
            adminClient.updateMonitorData();
            closeModal('color-modal');
            delete this.dataset.editIndex;
        });

        // Multiple image upload handler (GitHub Pages - disabled)
        function handleMultipleImageUpload(event) {
            alert('Upload de imagens não disponível no GitHub Pages. Use a versão local para fazer uploads.');
            event.target.value = '';
        }

        function removeImagePreview(button) {
            button.parentElement.remove();
            // Update form data by rebuilding from remaining previews
            const form = document.getElementById('product-form');
            const container = document.getElementById('image-preview-container');
            const remainingImages = container.querySelectorAll('img');
            
            const imagePaths = [];
            remainingImages.forEach((img) => {
                // Extract the path from the src attribute (remove leading slash)
                const src = img.src;
                const path = src.replace(window.location.origin + '/', '');
                imagePaths.push(path);
            });
            
            form.dataset.images = JSON.stringify(imagePaths);
        }

        // Update addColorVariation to use pre-defined colors
        function addColorVariation() {
            const colorList = document.getElementById('color-list');
            const colorId = Date.now();
            
            // Build color options from available colors
            let colorOptions = '';
            adminClient.data.colors.forEach(color => {
                colorOptions += `<option value="${color.name}" data-code="${color.code}">${color.name}</option>`;
            });
            
            const colorItem = document.createElement('div');
            colorItem.id = `color-${colorId}`;
            colorItem.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px;';
            colorItem.innerHTML = `
                <select onchange="updateColorPreview(this, ${colorId})" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Selecione uma cor</option>
                    ${colorOptions}
                </select>
                <div id="color-preview-${colorId}" style="width: 30px; height: 30px; border: 1px solid #ddd; border-radius: 4px; background: #f0f0f0;"></div>
                <button type="button" onclick="removeColorVariation(${colorId})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remover</button>
            `;
            colorList.appendChild(colorItem);
        }

        function updateColorPreview(select, colorId) {
            const preview = document.getElementById(`color-preview-${colorId}`);
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.dataset.code) {
                preview.style.background = selectedOption.dataset.code;
            } else {
                preview.style.background = '#f0f0f0';
            }
        }

        function removeColorVariation(colorId) {
            document.getElementById(`color-${colorId}`).remove();
        }

        // Load existing images when editing product
        function loadExistingImages(product) {
            const form = document.getElementById('product-form');
            const images = product.images || (product.imageFile ? [product.imageFile] : []);
            
            if (images.length === 0) return;
            
            // Set form dataset with existing images
            form.dataset.images = JSON.stringify(images);
            
            images.forEach((imagePath) => {
                let imageSrc = imagePath;
                
                // Handle different image path formats
                if (imagePath.startsWith('data:')) {
                    // Base64 data URL
                    imageSrc = imagePath;
                } else {
                    // Try localStorage first
                    const cleanPath = imagePath.replace(/^data\/images\//, '');
                    const storedImage = localStorage.getItem(`image_${cleanPath}`);
                    if (storedImage && storedImage.startsWith('data:')) {
                        imageSrc = storedImage;
                    } else {
                        // Fallback to GitHub URL (may not load but will show in gallery)
                        imageSrc = imagePath.startsWith('data/images/') ? 
                            `${adminClient.baseUrl}/${imagePath}` : 
                            `${adminClient.baseUrl}/data/images/${cleanPath}`;
                    }
                }
                
                // Add to gallery using existing function
                addImageToGallery(imageSrc, imagePath, 'product-image-gallery');
            });
        }

        // Load existing colors when editing product
        function loadExistingColors(product) {
            const colorList = document.getElementById('color-list');
            colorList.innerHTML = '';
            
            const colorVariations = product.colorVariations || [];
            if (colorVariations.length === 0) return;
            
            colorVariations.forEach(colorName => {
                const colorId = Date.now() + Math.random();
                const colorItem = document.createElement('div');
                colorItem.id = `color-${colorId}`;
                colorItem.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px;';
                
                // Find color data
                const colorData = adminClient.data.colors.find(c => c.name === colorName);
                const colorCode = colorData ? colorData.code : '#000000';
                
                // Build color options
                let colorOptions = '<option value="">Selecione uma cor</option>';
                adminClient.data.colors.forEach(color => {
                    const selected = color.name === colorName ? 'selected' : '';
                    colorOptions += `<option value="${color.name}" data-code="${color.code}" ${selected}>${color.name}</option>`;
                });
                
                colorItem.innerHTML = `
                    <select onchange="updateColorPreview(this, ${colorId})" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        ${colorOptions}
                    </select>
                    <div id="color-preview-${colorId}" style="width: 30px; height: 30px; border: 1px solid #ddd; border-radius: 4px; background: ${colorCode};"></div>
                    <button type="button" onclick="removeColorVariation(${colorId})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remover</button>
                `;
                colorList.appendChild(colorItem);
            });
        }

        // Clear image previews
        function clearImagePreviews() {
            const previewContainer = document.getElementById('image-preview-container');
            if (previewContainer) previewContainer.innerHTML = '';
            
            const form = document.getElementById('product-form');
            delete form.dataset.imageFiles;
            delete form.dataset.imageData;
        }

        // Clear color variations
        function clearColorVariations() {
            const colorList = document.getElementById('color-list');
            if (colorList) colorList.innerHTML = '';
        }

        // Remove existing image
        function removeExistingImage(button, imageIndex) {
            const form = document.getElementById('product-form');
            let fileNames = JSON.parse(form.dataset.imageFiles || '[]');
            let imageData = JSON.parse(form.dataset.imageData || '[]');
            
            // Remove the image at the specified index
            fileNames.splice(imageIndex, 1);
            imageData.splice(imageIndex, 1);
            
            // Update form data
            form.dataset.imageFiles = JSON.stringify(fileNames);
            form.dataset.imageData = JSON.stringify(imageData);
            
            // Remove the preview element
            button.parentElement.remove();
            
            // Update indices for remaining images
            const previewContainer = document.getElementById('image-preview-container');
            const remainingPreviews = previewContainer.children;
            Array.from(remainingPreviews).forEach((preview, newIndex) => {
                const removeBtn = preview.querySelector('button');
                if (removeBtn) {
                    removeBtn.onclick = () => removeExistingImage(removeBtn, newIndex);
                }
            });
            
            addSystemLog('Imagem removida do produto');
        }

        // Load existing category image
        function loadExistingCategoryImage(category) {
            const previewContainer = document.getElementById('category-image-preview');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (category.imageFile) {
                let imageSrc = category.imageFile;
                
                // Use GitHub Pages URLs for all images
                if (!imageSrc.startsWith('http')) {
                    imageSrc = imageSrc.startsWith('data/images/') ? 
                        `${adminClient.baseUrl}/${imageSrc}` : 
                        `${adminClient.baseUrl}/data/images/${imageSrc.replace(/^data\/images\//, '')}`;
                }
                
                // Create preview element
                const previewDiv = document.createElement('div');
                previewDiv.style.cssText = 'position: relative; display: inline-block; margin: 4px;';
                previewDiv.innerHTML = `
                    <img src="${imageSrc}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                    <button type="button" onclick="removeCategoryImage()" style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; background: #dc3545; color: white; border: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">×</button>
                `;
                previewContainer.appendChild(previewDiv);
                
                // Set form data
                const form = document.getElementById('category-form');
                form.dataset.imageFile = category.imageFile;
                form.dataset.imageData = imageSrc;
            }
        }

        // Clear category image previews
        function clearCategoryImagePreviews() {
            const previewContainer = document.getElementById('category-image-preview');
            if (previewContainer) previewContainer.innerHTML = '';
            
            const form = document.getElementById('category-form');
            delete form.dataset.imageFile;
            delete form.dataset.imageData;
        }

        // Remove category image
        function removeCategoryImage() {
            const previewContainer = document.getElementById('category-image-preview');
            if (previewContainer) previewContainer.innerHTML = '';
            
            const form = document.getElementById('category-form');
            delete form.dataset.imageFile;
            delete form.dataset.imageData;
            
            const input = document.getElementById('category-image');
            if (input) input.value = '';
            
            addSystemLog('Imagem removida da categoria');
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            adminClient = new AdminClient();
            adminClient.init().catch(error => {
                console.error('Erro na inicialização:', error);
            });
            
            // Start monitor updates
            startMonitorUpdates();
            
            // Update GitHub token status
            updateGitHubTokenStatus();
            
            // Add initial system log
            addSystemLog('Sistema inicializado');
        });

        console.log('MoveisBonafe Admin Panel - GitHub Pages');
        console.log('Sistema: GitHub API integrado com fallback localStorage');
    </script>

    <style>
        /* Product Image Styling */
        .product-image-cell {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            margin: 0 auto;
        }

        .product-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .image-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #9ca3af;
            background: #f3f4f6;
        }

        .image-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #059669;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Table styling improvements */
        .data-table td {
            vertical-align: middle;
            padding: 12px 8px;
        }

        .price-cell {
            font-weight: 600;
            color: #059669;
            text-align: right;
        }

        .action-buttons-cell {
            white-space: nowrap;
        }

        .action-buttons-cell .btn {
            margin: 0 2px;
        }
    </style>
</body>
</html>