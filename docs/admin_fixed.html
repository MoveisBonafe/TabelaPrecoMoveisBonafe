<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoveisBonafe - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .color-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .color-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .system-log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>MoveisBonafe - Admin Panel</h1>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                <span class="status-indicator status-online"></span>
                <span>Sistema Online</span>
                <span id="github-status" class="status-indicator status-offline"></span>
                <span id="github-status-text">GitHub Desconectado</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">Produtos</button>
            <button class="tab" onclick="switchTab('categories')">Categorias</button>
            <button class="tab" onclick="switchTab('colors')">Cores</button>
            <button class="tab" onclick="switchTab('settings')">Configurações</button>
        </div>

        <!-- Products Tab -->
        <div id="products-tab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gerenciar Produtos</h2>
                <button class="btn btn-primary" onclick="openProductModal()">Adicionar Produto</button>
            </div>
            
            <div id="products-grid" class="product-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gerenciar Categorias</h2>
                <button class="btn btn-primary" onclick="openCategoryModal()">Adicionar Categoria</button>
            </div>
            
            <div id="categories-grid" class="product-grid">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Colors Tab -->
        <div id="colors-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gerenciar Cores</h2>
                <button class="btn btn-primary" onclick="openColorModal()">Adicionar Cor</button>
            </div>
            
            <div id="colors-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                <!-- Colors will be loaded here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <h2>Configurações do Sistema</h2>
            
            <div class="form-group">
                <label>Token GitHub (para upload de imagens):</label>
                <input type="password" id="github-token" placeholder="Digite seu token GitHub">
                <button class="btn btn-primary" onclick="saveGitHubToken()">Salvar Token</button>
            </div>

            <div style="margin-top: 30px;">
                <h3>Status do Sistema</h3>
                <div class="system-log" id="system-log">
                    Sistema iniciado...<br>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="product-modal-title">Adicionar Produto</h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            
            <form id="product-form">
                <div class="form-group">
                    <label>Nome do Produto:</label>
                    <input type="text" id="product-name" required>
                </div>
                
                <div class="form-group">
                    <label>Categoria:</label>
                    <select id="product-category" required>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Preço à Vista (R$):</label>
                    <input type="number" id="product-price" step="0.01" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Altura (cm):</label>
                        <input type="number" id="product-height" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Largura (cm):</label>
                        <input type="number" id="product-width" step="0.1">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Comprimento (cm):</label>
                        <input type="number" id="product-length" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Peso (kg):</label>
                        <input type="number" id="product-weight" step="0.1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descrição:</label>
                    <textarea id="product-description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Imagens do Produto:</label>
                    <input type="file" id="product-images" multiple accept="image/*" onchange="previewImages()">
                    <div id="image-gallery" class="image-gallery"></div>
                </div>
                
                <div class="form-group">
                    <label>Variações de Cor:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="color-select">
                            <!-- Colors will be loaded here -->
                        </select>
                        <button type="button" class="btn btn-primary" onclick="addColorVariation()">Adicionar Cor</button>
                    </div>
                    <div id="selected-colors" class="color-options"></div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salvar Produto</button>
                    <button type="button" class="btn" onclick="closeProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global data store
        const adminData = {
            products: [],
            categories: [],
            colors: [],
            settings: {},
            repository: {
                owner: null,
                name: null,
                baseUrl: null
            }
        };

        let currentEditingProduct = null;
        let uploadedImages = [];
        let selectedColors = [];

        // Initialize admin panel
        async function initAdmin() {
            addLog('Iniciando sistema admin...');
            
            try {
                await detectRepository();
                await loadAllData();
                await checkGitHubToken();
                renderAllData();
                addLog('Sistema admin inicializado com sucesso');
            } catch (error) {
                addLog(`Erro na inicialização: ${error.message}`);
            }
        }

        // Detect GitHub repository information
        async function detectRepository() {
            try {
                const hostname = window.location.hostname;
                if (hostname.includes('github.io')) {
                    const parts = hostname.split('.');
                    if (parts.length >= 3) {
                        adminData.repository.owner = parts[0];
                        adminData.repository.name = window.location.pathname.split('/')[1] || parts[0] + '.github.io';
                        adminData.repository.baseUrl = `https://${hostname}${window.location.pathname.replace(/\/[^\/]*$/, '')}`;
                        addLog(`Repositório detectado: ${adminData.repository.owner}/${adminData.repository.name}`);
                        return;
                    }
                }
                
                // Fallback detection via GitHub API
                const response = await fetch('https://api.github.com/repos/movieisbonafe/TabelaPrecoMoveisBonafe');
                if (response.ok) {
                    const repoData = await response.json();
                    adminData.repository.owner = repoData.owner.login;
                    adminData.repository.name = repoData.name;
                    adminData.repository.baseUrl = repoData.homepage || `https://${adminData.repository.owner}.github.io/${adminData.repository.name}`;
                    addLog(`Repositório detectado via API: ${adminData.repository.owner}/${adminData.repository.name}`);
                }
            } catch (error) {
                addLog(`Erro ao detectar repositório: ${error.message}`);
            }
        }

        // Load all data from GitHub/localStorage
        async function loadAllData() {
            try {
                // Load products
                const products = await loadJsonData('products.json');
                adminData.products = products || [];
                addLog(`Carregados ${adminData.products.length} produtos`);

                // Load categories
                const categories = await loadJsonData('categories.json');
                adminData.categories = categories || [];
                addLog(`Carregadas ${adminData.categories.length} categorias`);

                // Load colors
                const colors = await loadJsonData('colors.json');
                adminData.colors = colors || [
                    { name: 'Cerejeira', code: '#ffc852' },
                    { name: 'Imbuia', code: '#8c5b17' },
                    { name: 'Mogno', code: '#9a1919' },
                    { name: 'Tabaco', code: '#000000' }
                ];
                addLog(`Carregadas ${adminData.colors.length} cores`);

            } catch (error) {
                addLog(`Erro ao carregar dados: ${error.message}`);
            }
        }

        // Load JSON data with fallback to localStorage
        async function loadJsonData(filename) {
            try {
                // Try localStorage first
                const localData = localStorage.getItem(`moveisbonafe_${filename.replace('.json', '')}`);
                if (localData) {
                    return JSON.parse(localData);
                }

                // Try GitHub if repository is detected
                if (adminData.repository.baseUrl) {
                    const response = await fetch(`${adminData.repository.baseUrl}/data/${filename}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Save to localStorage for offline use
                        localStorage.setItem(`moveisbonafe_${filename.replace('.json', '')}`, JSON.stringify(data));
                        return data;
                    }
                }
                
                return null;
            } catch (error) {
                addLog(`Erro ao carregar ${filename}: ${error.message}`);
                return null;
            }
        }

        // Save data to GitHub and localStorage
        async function saveJsonData(filename, data) {
            try {
                // Always save to localStorage first
                localStorage.setItem(`moveisbonafe_${filename.replace('.json', '')}`, JSON.stringify(data));
                addLog(`Dados salvos localmente: ${filename}`);

                // Try to save to GitHub if token is available
                const token = localStorage.getItem('github_token');
                if (token && adminData.repository.owner && adminData.repository.name) {
                    await saveToGitHub(filename, data, token);
                    addLog(`Dados salvos no GitHub: ${filename}`);
                }

                return true;
            } catch (error) {
                addLog(`Erro ao salvar ${filename}: ${error.message}`);
                return false;
            }
        }

        // Save to GitHub via API
        async function saveToGitHub(filename, data, token) {
            const filePath = `docs/data/${filename}`;
            const apiUrl = `https://api.github.com/repos/${adminData.repository.owner}/${adminData.repository.name}/contents/${filePath}`;
            
            try {
                // Get current file SHA if it exists
                let sha = null;
                try {
                    const getResponse = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's okay
                }

                // Create or update file
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const payload = {
                    message: `Update ${filename}`,
                    content: content
                };
                
                if (sha) {
                    payload.sha = sha;
                }

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                return true;
            } catch (error) {
                throw new Error(`Failed to save to GitHub: ${error.message}`);
            }
        }

        // Upload image to GitHub
        async function uploadImageToGitHub(file, filename) {
            const token = localStorage.getItem('github_token');
            if (!token) {
                throw new Error('GitHub token não configurado');
            }

            const filePath = `docs/data/images/${filename}`;
            const apiUrl = `https://api.github.com/repos/${adminData.repository.owner}/${adminData.repository.name}/contents/${filePath}`;

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const content = e.target.result.split(',')[1]; // Remove data:image/... prefix
                        
                        const response = await fetch(apiUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Upload image: ${filename}`,
                                content: content
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        resolve(result.content.download_url);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Check GitHub token validity
        async function checkGitHubToken() {
            const token = localStorage.getItem('github_token');
            const statusIndicator = document.getElementById('github-status');
            const statusText = document.getElementById('github-status-text');
            
            if (!token) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Token não configurado';
                return false;
            }

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'GitHub Conectado';
                    return true;
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'Token inválido';
                    return false;
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Erro de conexão';
                return false;
            }
        }

        // Render all data
        function renderAllData() {
            renderProducts();
            renderCategories();
            renderColors();
            populateSelects();
        }

        // Render products
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            adminData.products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                // Handle images
                let imageHtml = '<div style="background: #f8f9fa; width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; color: #666;">Sem imagem</div>';
                if (product.images && product.images.length > 0) {
                    const imageSrc = product.images[0].startsWith('data:') ? 
                        product.images[0] : 
                        `${adminData.repository.baseUrl}/data/images/${product.images[0].replace(/^data\/images\//, '')}`;
                    imageHtml = `<img src="${imageSrc}" alt="${product.name}" onerror="this.parentNode.innerHTML='<div style=&quot;background: #f8f9fa; width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; color: #666;&quot;>Erro ao carregar</div>'">`;
                }

                // Handle colors
                let colorsHtml = '';
                if (product.colorVariations && product.colorVariations.length > 0) {
                    colorsHtml = '<div class="color-options">';
                    product.colorVariations.forEach(colorName => {
                        const colorData = adminData.colors.find(c => c.name === colorName);
                        const colorCode = colorData ? colorData.code : '#cccccc';
                        colorsHtml += `
                            <div class="color-option">
                                <div class="color-circle" style="background: ${colorCode};"></div>
                                <span>${colorName}</span>
                            </div>
                        `;
                    });
                    colorsHtml += '</div>';
                }

                card.innerHTML = `
                    <div class="product-image">${imageHtml}</div>
                    <h4>${product.name}</h4>
                    <p><strong>Categoria:</strong> ${product.category}</p>
                    <p><strong>Preço:</strong> R$ ${(product.priceAVista || 0).toFixed(2)}</p>
                    <p><strong>Dimensões:</strong> ${product.altura || 0} x ${product.largura || 0} x ${product.comprimento || 0} cm</p>
                    ${colorsHtml}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Excluir</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Render categories
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';

            adminData.categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                // Handle category image
                let imageHtml = '<div style="background: #f8f9fa; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; color: #666;">Sem imagem</div>';
                if (category.imageFile) {
                    const imageSrc = category.imageFile.startsWith('data:') ? 
                        category.imageFile : 
                        `${adminData.repository.baseUrl}/data/images/${category.imageFile.replace(/^data\/images\//, '')}`;
                    imageHtml = `<img src="${imageSrc}" alt="${category.name}" style="width: 100%; height: 150px; object-fit: cover;" onerror="this.parentNode.innerHTML='<div style=&quot;background: #f8f9fa; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; color: #666;&quot;>Erro ao carregar</div>'">`;
                }

                const productCount = adminData.products.filter(p => p.category === category.name).length;

                card.innerHTML = `
                    <div style="height: 150px; margin-bottom: 10px;">${imageHtml}</div>
                    <h4>${category.name}</h4>
                    <p>${category.description || 'Sem descrição'}</p>
                    <p><strong>Produtos:</strong> ${productCount}</p>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editCategory(${JSON.stringify(category).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteCategory('${category.id}')">Excluir</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Render colors
        function renderColors() {
            const list = document.getElementById('colors-list');
            list.innerHTML = '';

            adminData.colors.forEach(color => {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px;';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div class="color-circle" style="background: ${color.code}; width: 30px; height: 30px;"></div>
                        <div>
                            <h4 style="margin: 0;">${color.name}</h4>
                            <p style="margin: 0; color: #666; font-family: monospace;">${color.code}</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editColor(${JSON.stringify(color).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn btn-danger" onclick="deleteColor('${color.name}')">Excluir</button>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }

        // Populate select elements
        function populateSelects() {
            // Product category select
            const categorySelect = document.getElementById('product-category');
            categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            adminData.categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.name}">${category.name}</option>`;
            });

            // Color select
            const colorSelect = document.getElementById('color-select');
            colorSelect.innerHTML = '<option value="">Selecione uma cor</option>';
            adminData.colors.forEach(color => {
                colorSelect.innerHTML += `<option value="${color.name}" data-code="${color.code}">${color.name}</option>`;
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        // Product management
        function openProductModal(product = null) {
            currentEditingProduct = product;
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('product-modal-title');
            
            if (product) {
                title.textContent = 'Editar Produto';
                fillProductForm(product);
            } else {
                title.textContent = 'Adicionar Produto';
                clearProductForm();
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
            clearProductForm();
            currentEditingProduct = null;
        }

        function fillProductForm(product) {
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-price').value = product.priceAVista || 0;
            document.getElementById('product-height').value = product.altura || '';
            document.getElementById('product-width').value = product.largura || '';
            document.getElementById('product-length').value = product.comprimento || '';
            document.getElementById('product-weight').value = product.peso || '';
            document.getElementById('product-description').value = product.description || '';
            
            // Load existing images
            uploadedImages = product.images || [];
            displayImageGallery();
            
            // Load existing colors
            selectedColors = product.colorVariations || [];
            displaySelectedColors();
        }

        function clearProductForm() {
            document.getElementById('product-form').reset();
            uploadedImages = [];
            selectedColors = [];
            displayImageGallery();
            displaySelectedColors();
        }

        // Image handling
        function previewImages() {
            const input = document.getElementById('product-images');
            const files = Array.from(input.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push(e.target.result);
                        displayImageGallery();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            input.value = ''; // Clear input
        }

        function displayImageGallery() {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';
            
            uploadedImages.forEach((imageSrc, index) => {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.innerHTML = `
                    <img src="${imageSrc}" alt="Preview ${index + 1}">
                    <button class="image-remove" onclick="removeImage(${index})">&times;</button>
                `;
                gallery.appendChild(preview);
            });
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImageGallery();
        }

        // Color handling
        function addColorVariation() {
            const select = document.getElementById('color-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && !selectedColors.includes(selectedOption.value)) {
                selectedColors.push(selectedOption.value);
                displaySelectedColors();
            }
        }

        function displaySelectedColors() {
            const container = document.getElementById('selected-colors');
            container.innerHTML = '';
            
            selectedColors.forEach(colorName => {
                const colorData = adminData.colors.find(c => c.name === colorName);
                const colorCode = colorData ? colorData.code : '#cccccc';
                
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.innerHTML = `
                    <div class="color-circle" style="background: ${colorCode};"></div>
                    <span>${colorName}</span>
                    <button type="button" onclick="removeColor('${colorName}')" style="margin-left: 10px; background: #dc3545; color: white; border: none; border-radius: 2px; padding: 2px 6px; cursor: pointer;">&times;</button>
                `;
                container.appendChild(colorDiv);
            });
        }

        function removeColor(colorName) {
            selectedColors = selectedColors.filter(c => c !== colorName);
            displaySelectedColors();
        }

        // Save product
        async function saveProduct(event) {
            event.preventDefault();
            
            try {
                addLog('Salvando produto...');
                
                const productData = {
                    name: document.getElementById('product-name').value,
                    category: document.getElementById('product-category').value,
                    priceAVista: parseFloat(document.getElementById('product-price').value) || 0,
                    altura: parseFloat(document.getElementById('product-height').value) || 0,
                    largura: parseFloat(document.getElementById('product-width').value) || 0,
                    comprimento: parseFloat(document.getElementById('product-length').value) || 0,
                    peso: parseFloat(document.getElementById('product-weight').value) || 0,
                    description: document.getElementById('product-description').value,
                    images: uploadedImages,
                    colorVariations: selectedColors,
                    active: true,
                    updatedAt: new Date().toISOString()
                };

                if (currentEditingProduct) {
                    // Update existing product
                    productData.id = currentEditingProduct.id;
                    productData.createdAt = currentEditingProduct.createdAt;
                    
                    const index = adminData.products.findIndex(p => p.id === currentEditingProduct.id);
                    if (index !== -1) {
                        adminData.products[index] = productData;
                    }
                } else {
                    // Add new product
                    productData.id = Date.now();
                    productData.createdAt = new Date().toISOString();
                    adminData.products.push(productData);
                }

                // Save to storage
                await saveJsonData('products.json', adminData.products);
                
                addLog(`Produto "${productData.name}" salvo com sucesso`);
                closeProductModal();
                renderProducts();
                
            } catch (error) {
                addLog(`Erro ao salvar produto: ${error.message}`);
                alert('Erro ao salvar produto. Verifique o console para mais detalhes.');
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) {
                return;
            }
            
            try {
                adminData.products = adminData.products.filter(p => p.id !== productId);
                await saveJsonData('products.json', adminData.products);
                addLog('Produto excluído com sucesso');
                renderProducts();
            } catch (error) {
                addLog(`Erro ao excluir produto: ${error.message}`);
            }
        }

        // Save GitHub token
        function saveGitHubToken() {
            const token = document.getElementById('github-token').value;
            if (token) {
                localStorage.setItem('github_token', token);
                addLog('Token GitHub salvo');
                checkGitHubToken();
                document.getElementById('github-token').value = '';
            }
        }

        // Add log entry
        function addLog(message) {
            const log = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        // Event listeners
        document.getElementById('product-form').addEventListener('submit', saveProduct);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>
</html>